---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on:
  - 01-02
files_modified:
  - src/worker/worker.ts
  - src/worker/handlers/atoms.ts
  - src/worker/handlers/sections.ts
  - src/worker/handlers/inbox.ts
  - src/ui/signals/store.ts
  - src/app.tsx
  - src/index.tsx
  - src/ui/layout/Shell.tsx
  - src/ui/layout/Sidebar.tsx
  - src/ui/layout/BottomTabBar.tsx
  - src/ui/layout/PageTabStrip.tsx
  - src/ui/layout/StatusBar.tsx
  - src/ui/layout/MainPane.tsx
  - src/ui/layout/layout.css
  - src/ui/theme/colors.ts
  - index.html
autonomous: true
requirements:
  - TRST-02
  - TRST-04
  - ORG-09

must_haves:
  truths:
    - "User sees a dark-themed binder UI with sidebar (sections), page tabs, main pane, and status bar"
    - "User can navigate between sections (Projects, Areas, Resources, Archive) via sidebar or bottom tab bar"
    - "Status bar shows atom count, inbox count, storage used, and persistence status"
    - "On mobile, bottom tab bar and page tab strip provide navigation; sidebar is hidden"
    - "Worker dispatches commands for atom CRUD, inbox, sections, undo, and export"
    - "SolidJS store is reactively updated via reconcile on every Worker STATE_UPDATE message"
  artifacts:
    - path: "src/ui/layout/Shell.tsx"
      provides: "Root layout component with responsive grid (sidebar/bottom tabs + page tabs + main pane + status bar)"
      min_lines: 40
    - path: "src/ui/layout/Sidebar.tsx"
      provides: "Desktop sidebar with section navigation"
      min_lines: 20
    - path: "src/ui/layout/BottomTabBar.tsx"
      provides: "Mobile bottom tab bar for section navigation"
      min_lines: 20
    - path: "src/ui/layout/StatusBar.tsx"
      provides: "IDE-style status bar with persistence, atom count, inbox count, storage stats"
      min_lines: 20
    - path: "src/ui/signals/store.ts"
      provides: "SolidJS reactive store fed by Worker message bridge"
      contains: "createStore"
    - path: "src/worker/handlers/atoms.ts"
      provides: "Worker command handlers for atom CRUD with Zod validation and changelog"
      contains: "handleCreateAtom"
  key_links:
    - from: "src/ui/signals/store.ts"
      to: "src/worker/bridge.ts"
      via: "Worker onMessage callback feeds store via reconcile"
      pattern: "reconcile"
    - from: "src/worker/handlers/atoms.ts"
      to: "src/storage/db.ts"
      via: "Atom CRUD writes through write queue to Dexie"
      pattern: "writeQueue\\.enqueue"
    - from: "src/worker/handlers/atoms.ts"
      to: "src/storage/changelog.ts"
      via: "Every mutation appends a changelog entry"
      pattern: "appendMutation"
    - from: "src/ui/layout/Shell.tsx"
      to: "src/ui/layout/Sidebar.tsx"
      via: "Responsive layout shows sidebar on desktop"
      pattern: "Sidebar"
    - from: "src/ui/layout/Shell.tsx"
      to: "src/ui/layout/BottomTabBar.tsx"
      via: "Responsive layout shows bottom tabs on mobile"
      pattern: "BottomTabBar"
---

<objective>
Build the Worker command handlers, SolidJS reactive store, and the binder UI shell frame with dark theme and responsive layout.

Purpose: This plan delivers the structural backbone of the application. Worker handlers make atom CRUD, inbox, undo, and export functional. The SolidJS store bridges Worker state into reactive UI. The shell frame establishes the responsive layout (sidebar on desktop, bottom tab bar on mobile, page tab strip, status bar) that all views and components render inside. Plan 01-04 fills in the views and components.

Output: Functional Worker command dispatch, reactive store, and a rendered dark-themed shell frame with navigation and status bar. Views show placeholder content until Plan 01-04.
</objective>

<execution_context>
@C:/Users/patri/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/patri/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Worker command handlers for atom CRUD, inbox, sections, undo, and export</name>
  <files>
    src/worker/worker.ts
    src/worker/handlers/atoms.ts
    src/worker/handlers/sections.ts
    src/worker/handlers/inbox.ts
    src/ui/signals/store.ts
  </files>
  <action>
1. Create `src/worker/handlers/atoms.ts`:
   - `handleCreateAtom(payload: CreateAtomInput): Promise<{ atom: Atom; logEntry: MutationLogEntry }>` -- generates UUID for id, sets created_at and updated_at to Date.now(), validates with AtomSchema.parse() (throws on invalid), creates changelog entry via appendMutation('create', null, atom), enqueues both atom write and changelog write to writeQueue, returns atom and logEntry.
   - `handleUpdateAtom(payload: { id: string; changes: Partial<Atom> }): Promise<{ atom: Atom; logEntry: MutationLogEntry }>` -- reads current atom from db.atoms.get(id), merges changes, sets updated_at to Date.now(), validates merged atom with AtomSchema.parse(), creates changelog entry with before=old and after=new, enqueues writes, returns.
   - `handleDeleteAtom(payload: { id: string }): Promise<{ logEntry: MutationLogEntry }>` -- reads current atom, creates changelog entry with before=atom and after=null, enqueues delete + changelog write, returns.
   - All handlers validate input with Zod BEFORE touching Dexie. On validation failure, throw with descriptive message.

2. Create `src/worker/handlers/inbox.ts`:
   - `handleCreateInboxItem(payload: { content: string; title?: string }): Promise<InboxItem>` -- generates UUID, sets isInbox: true, type: undefined, created_at/updated_at to Date.now(), validates with InboxItemSchema.parse(), enqueues to writeQueue (db.inbox.put), returns item.
   - `handleClassifyInboxItem(payload: { id: string; type: AtomType; sectionItemId?: string }): Promise<Atom>` -- reads inbox item, converts to Atom by setting type and removing isInbox flag, validates with AtomSchema.parse(), enqueues: delete from inbox + put to atoms + changelog entry, returns new atom.

3. Create `src/worker/handlers/sections.ts`:
   - `handleCreateSectionItem(payload: { sectionId: string; name: string }): Promise<SectionItem>` -- generates UUID, validates, enqueues to writeQueue.
   - `handleRenameSectionItem(payload: { id: string; name: string }): Promise<SectionItem>` -- reads, updates name and updated_at, enqueues.
   - `handleArchiveSectionItem(payload: { id: string }): Promise<SectionItem>` -- reads, sets archived: true and updated_at, enqueues.

4. Update `src/worker/worker.ts` to be a full command dispatcher:
   - On INIT: await WASM init, initialize lamport clock (initLamportClock()), load all atoms/inbox/sections/sectionItems from Dexie, check persistence status, postMessage READY with full state snapshot.
   - Route each command type to the appropriate handler
   - After each mutation handler: flush writeQueue, then read fresh state from Dexie (atoms, inbox, sections, sectionItems), postMessage STATE_UPDATE with full state
   - UNDO: read latest changelog entry for the most recent atom (or accept atomId in payload), read the `before` snapshot, if before is null (was a create) delete the atom, if before exists overwrite with before snapshot, create a new changelog entry for the undo itself, flush and send STATE_UPDATE
   - EXPORT_DATA: call flushImmediate() on writeQueue first, then call exportAllData() from storage/export.ts
   - REQUEST_PERSISTENCE: call initStoragePersistence(), postMessage PERSISTENCE_STATUS
   - Wrap every handler in try/catch, postMessage ERROR on failure with the command type for debugging

5. Create `src/ui/signals/store.ts`:
   - Import createStore and reconcile from 'solid-js/store'
   - Import initWorker, dispatch, onMessage from '../worker/bridge'
   - Define BinderState interface: { ready: boolean; version: string; atoms: Atom[]; inboxItems: InboxItem[]; sections: Section[]; sectionItems: SectionItem[]; persistenceGranted: boolean; activeSection: string | null; activePage: string }
   - Create [state, setState] = createStore<BinderState>(initialState)
   - Set up onMessage handler:
     - On READY: setState(reconcile({ ...payload, ready: true }))
     - On STATE_UPDATE: setState(reconcile(payload)) -- SolidJS reconcile does fine-grained diff, only updates what changed
     - On ERROR: console.error and optionally store last error
     - On PERSISTENCE_STATUS: setState('persistenceGranted', payload.granted)
   - Export state (readonly), dispatch function, and derived signals:
     - `atomCount(): number` -- state.atoms.length
     - `inboxCount(): number` -- state.inboxItems.length
     - `atomsBySection(sectionId: string): Atom[]` -- filtered
     - `atomsBySectionItem(sectionItemId: string): Atom[]` -- filtered
   - CRITICAL: Never destructure state or payload. Always use state.atoms, state.inboxItems etc. Destructuring breaks SolidJS reactivity (RESEARCH.md Pitfall 2).
  </action>
  <verify>
1. `pnpm lint` passes on all handler and store files
2. `pnpm build` succeeds
3. In browser console: Worker INIT completes and READY message received with sections array of length 4
4. dispatch({ type: 'CREATE_INBOX_ITEM', payload: { content: 'Test', title: 'Test Item' } }) -- verify inbox table in DevTools has the item
5. Undo flow: create an atom, dispatch UNDO, verify atom is removed from atoms table and changelog has undo entry
  </verify>
  <done>
Worker handles all Phase 1 commands: atom CRUD, inbox create/classify, section item management, undo, export, persistence check. SolidJS store receives state updates via reconcile. All mutations create CRDT-compatible changelog entries. Undo reads the `before` snapshot from the most recent changelog entry and reverts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build binder UI shell frame with dark theme, responsive layout, navigation, and status bar</name>
  <files>
    src/app.tsx
    src/index.tsx
    src/ui/layout/Shell.tsx
    src/ui/layout/Sidebar.tsx
    src/ui/layout/BottomTabBar.tsx
    src/ui/layout/PageTabStrip.tsx
    src/ui/layout/StatusBar.tsx
    src/ui/layout/MainPane.tsx
    src/ui/layout/layout.css
    src/ui/theme/colors.ts
    index.html
  </files>
  <action>
Per user decisions: Mobile-first PWA, dark theme by default (Warp terminal command-center feel #0d1117), subtle binder hints (tab shapes, divider lines -- not skeuomorphic), distinct colors per atom type, hybrid density (compact rows, expand on click), mobile bottom tab bar, horizontal page tab strip, IDE-style status bar with entropy health + atom count + inbox count + storage used + persistence status, no badges anywhere.

1. Create `src/ui/theme/colors.ts`:
   - Background colors: bg-primary '#0d1117', bg-secondary '#161b22', bg-tertiary '#21262d'
   - Border/divider: border-primary '#30363d', border-secondary '#484f58'
   - Text: text-primary '#e6edf3', text-secondary '#8b949e', text-muted '#484f58'
   - Atom type signature colors (distinct, vibrant against dark bg):
     - task: '#58a6ff' (blue)
     - fact: '#3fb950' (green)
     - event: '#d29922' (amber)
     - decision: '#bc8cff' (purple)
     - insight: '#f778ba' (pink)
   - Status colors: success '#3fb950', warning '#d29922', error '#f85149'
   - Export as a `theme` object

2. Create `src/ui/layout/layout.css` per RESEARCH.md Pattern 7:
   - CSS custom properties mapped from theme colors (--bg-primary, --text-primary, etc.)
   - Global reset: box-sizing border-box, margin 0, font-family system-ui
   - Body: background var(--bg-primary), color var(--text-primary), overflow hidden
   - Shell grid layout: on desktop (min-width 768px) -- sidebar 260px, main area 1fr; on mobile -- full width, no sidebar
   - Bottom tab bar: fixed bottom, height calc(56px + env(safe-area-inset-bottom)), padding-bottom env(safe-area-inset-bottom), bg #0d1117, border-top 1px solid #30363d, flexbox, z-index 100. ONLY visible on mobile (max-width 767px).
   - Status bar: fixed, positioned above bottom tab bar on mobile (bottom: calc(56px + env(safe-area-inset-bottom))), at very bottom on desktop. Height 32px, bg #0d1117, border-top, font-size 12px, flexbox, z-index 99.
   - Main content: padding-bottom to account for status bar + bottom tab bar + safe area
   - Page tab strip: horizontal scrollable, no wrap, gap 0, border-bottom 1px solid divider
   - Sidebar: bg-secondary, border-right, height 100vh, overflow-y auto, hidden on mobile
   - Scrollbar styling for dark theme (thin, dark track/thumb)

3. Create `src/ui/layout/Shell.tsx`:
   - Root layout component using CSS Grid
   - Desktop (768px+): sidebar on left, main area on right (page tabs + main pane)
   - Mobile (<768px): full-width main area + bottom tab bar
   - Status bar always visible at the bottom
   - Import and render: Sidebar (desktop only), BottomTabBar (mobile only), PageTabStrip, MainPane, StatusBar
   - Use `window.matchMedia('(min-width: 768px)')` wrapped in a SolidJS signal to detect viewport
   - Accept activeSection and activePage from store, pass to children

4. Create `src/ui/layout/Sidebar.tsx`:
   - Left sidebar showing the four sections (Projects, Areas, Resources, Archive) with icons
   - Each section is clickable, sets activeSection in store via dispatch or local state
   - Below sections: list of SectionItems for the active section (from store)
   - "Add" button per section to create new section items
   - Subtle binder hint: vertical divider line on the right edge that looks like a binder spine
   - Use `<For>` component (not .map()) per SolidJS ESLint rules

5. Create `src/ui/layout/BottomTabBar.tsx`:
   - Four tab buttons for the four sections (Projects, Areas, Resources, Archive) with icons and labels
   - Active tab highlighted with atom type color or accent color
   - Positioned per layout.css (fixed bottom with safe area insets)
   - Only visible on mobile (CSS handles visibility)

6. Create `src/ui/layout/PageTabStrip.tsx`:
   - Horizontal scrollable strip of page tabs (Inbox, All, + section-specific views)
   - Active tab has a bottom border indicator (Material-style)
   - For Phase 1: tabs are Inbox, All Items, and one per section. Phase 3 adds query pages (Today, This Week, etc.)
   - Scrollable on mobile via overflow-x auto with -webkit-overflow-scrolling: touch

7. Create `src/ui/layout/StatusBar.tsx`:
   - IDE-style bar at the bottom with segments:
     - Persistence status: green dot if granted, red dot with "Storage not persistent" if denied
     - Atom count: "42 atoms"
     - Inbox count: "3 inbox"
     - Storage used: from navigator.storage.estimate() -- "12 MB used" (or hide if not available)
   - Read all values from the SolidJS store (reactive)
   - No badges, no notifications -- this IS the ambient health indicator per user decision
   - Color shift: overall status bar subtle bg tint based on system health (green = all good, yellow = inbox getting full, red = persistence denied). For Phase 1, just persistence status drives color.

8. Create `src/ui/layout/MainPane.tsx`:
   - Content area that renders the active page/view
   - Routes based on activePage: 'inbox' -> placeholder div "Inbox view", 'section' -> placeholder div "Section view", 'all' -> placeholder div "All atoms"
   - These placeholders will be replaced by real view components in Plan 01-04
   - Scrollable content area

9. Update `src/app.tsx`:
   - On mount: call initWorker() from bridge, then dispatch REQUEST_PERSISTENCE
   - Render Shell component
   - Set up global keyboard shortcut listener:
     - Ctrl+Z / Cmd+Z: dispatch UNDO command
     - Escape: close any open overlay
   - NOTE: Capture overlay (Ctrl+N) and overlay state management will be added in Plan 01-04

10. Update `src/index.tsx`:
    - Import layout.css
    - Render App into root

CRITICAL SolidJS rules:
- Never destructure props: use `props.atom`, not `const { atom } = props`
- Use `<For>` for lists, not `.map()`
- Use `<Show>` for conditional rendering
- Feed Worker responses into setState(reconcile(payload)), never destructure the payload
  </action>
  <verify>
1. `pnpm lint` passes on all layout and theme files
2. `pnpm build` succeeds
3. `pnpm dev` -- open in browser:
   - Dark theme visible with #0d1117 background
   - Sidebar visible on desktop with four sections
   - Bottom tab bar visible on mobile viewport (Chrome DevTools device mode)
   - Status bar visible at bottom with persistence status and counts
   - Page tab strip shows Inbox and section tabs
   - MainPane shows placeholder text for active view
4. Worker INIT completes, READY message received, status bar shows "0 atoms" and "0 inbox"
5. Ctrl+Z dispatches UNDO (verify in console)
  </verify>
  <done>
Dark-themed binder shell frame renders with responsive layout: sidebar on desktop, bottom tab bar on mobile, page tab strip, status bar with persistence/counts. Worker command handlers fully functional for atom CRUD, inbox, sections, undo, export. SolidJS store reactively receives state updates. MainPane renders placeholder views ready for Plan 01-04 to fill in.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with all handler, store, and layout files
2. `pnpm lint` passes across all new files
3. App loads with dark theme and binder shell layout
4. Four sections visible: Projects, Areas, Resources, Archive
5. Worker dispatches and receives typed command/response messages
6. SolidJS store updates reactively via reconcile
7. Status bar shows persistence status, atom count (0), inbox count (0)
8. Mobile layout correct with bottom tabs and safe area insets
9. Undo command dispatches via Ctrl+Z
</verification>

<success_criteria>
- Worker handles all Phase 1 commands: atom CRUD, inbox, sections, undo, export, persistence
- SolidJS store bridges Worker state into reactive signals
- Binder shell frame renders with dark Warp-inspired theme
- Responsive layout: sidebar on desktop, bottom tab bar on mobile
- Page tab strip navigates between Inbox and section views
- Status bar shows persistence status, atom count, inbox count, storage used
- All mutations logged in CRDT-compatible changelog with lamport clock
- Undo (Ctrl+Z) reverts the most recent mutation
- MainPane renders placeholder views for 01-04 to replace
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
