---
phase: 02-compute-engine
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/ui/components/AtomCard.tsx
  - src/ui/components/PriorityBadge.tsx
  - src/ui/layout/StatusBar.tsx
  - src/ui/layout/layout.css
  - src/ui/components/CapEnforcementModal.tsx
  - src/worker/handlers/inbox.ts
  - src/worker/handlers/atoms.ts
  - src/worker/worker.ts
autonomous: true
requirements: [ENTR-04, ENTR-05, CAPT-02, CAPT-03, CAPT-04, CAPT-05, CAPT-06]

must_haves:
  truths:
    - "Each atom card visually shows staleness via opacity fade (100% fresh to 60% fully stale)"
    - "Tasks and Events show a priority tier badge (flame/arrow-up/dash/arrow-down/clock icon with tier color)"
    - "StatusBar shows entropy health indicator (green/yellow/red) with label"
    - "StatusBar inbox segment shifts color at 80% cap (green to yellow)"
    - "Adding a 21st inbox item (default cap 20) triggers a modal that blocks until one item is resolved"
    - "Adding beyond open task cap triggers the same resolution modal"
    - "Cap enforcement modal is not dismissable until at least one slot is freed"
  artifacts:
    - path: "src/ui/components/PriorityBadge.tsx"
      provides: "Tier icon + color badge component for Critical/High/Medium/Low/Someday"
      exports: ["PriorityBadge"]
    - path: "src/ui/components/CapEnforcementModal.tsx"
      provides: "Hard-block modal with triage list for inbox cap and task cap"
      exports: ["CapEnforcementModal"]
    - path: "src/ui/components/AtomCard.tsx"
      provides: "Extended with staleness opacity and PriorityBadge integration"
      contains: "opacity"
    - path: "src/ui/layout/StatusBar.tsx"
      provides: "Extended with entropy badge and cap status colors"
      contains: "entropy"
  key_links:
    - from: "src/ui/components/AtomCard.tsx"
      to: "src/ui/signals/store.ts"
      via: "reads state.scores[atom.id] for opacity and tier"
      pattern: "state\\.scores"
    - from: "src/ui/layout/StatusBar.tsx"
      to: "src/ui/signals/store.ts"
      via: "reads entropyScore and cap status memos"
      pattern: "entropyScore|capStatus"
    - from: "src/ui/components/CapEnforcementModal.tsx"
      to: "src/ui/signals/store.ts"
      via: "reads state.capExceeded, dispatches classify/archive/complete commands"
      pattern: "capExceeded"
    - from: "src/worker/handlers/inbox.ts"
      to: "src/worker/handlers/config.ts"
      via: "calls getCapConfig() before inbox insert"
      pattern: "getCapConfig"
---

<objective>
Add per-atom staleness visualization and priority badges to AtomCard, entropy health to StatusBar, and cap enforcement (soft warning + hard block modal) for both inbox and open task limits. After this plan, atoms visually communicate their priority and freshness, the system health is always visible, and caps are enforced with the advisory-first UX pattern.

Purpose: This is the user-facing discipline engine — the visual feedback loop that makes entropy management tangible and prevents accumulation without being punitive.
Output: PriorityBadge component, CapEnforcementModal component, extended AtomCard with opacity/badge, extended StatusBar with entropy/caps.
</objective>

<execution_context>
@C:/Users/patri/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/patri/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-compute-engine/02-CONTEXT.md
@.planning/phases/02-compute-engine/02-RESEARCH.md
@.planning/phases/02-compute-engine/02-01-SUMMARY.md

@src/ui/components/AtomCard.tsx
@src/ui/layout/StatusBar.tsx
@src/ui/layout/layout.css
@src/ui/signals/store.ts
@src/types/config.ts
@src/types/messages.ts
@src/worker/handlers/inbox.ts
@src/worker/handlers/atoms.ts
@src/worker/worker.ts
@src/ui/theme/colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: PriorityBadge + AtomCard staleness/priority + StatusBar entropy/caps</name>
  <files>
    src/ui/components/PriorityBadge.tsx
    src/ui/components/AtomCard.tsx
    src/ui/layout/StatusBar.tsx
    src/ui/layout/layout.css
    src/ui/theme/colors.ts
  </files>
  <action>
**PriorityBadge.tsx (NEW):**
- Props: { tier: PriorityTier } (import from src/types/config.ts)
- Renders a small inline badge with icon + tier-specific color:
  - Critical: flame icon (inline SVG), color red-ish (#f85149)
  - High: arrow-up icon, color orange (#d29922)
  - Medium: dash icon, color blue (#58a6ff)
  - Low: arrow-down icon, color muted (#8b949e)
  - Someday: clock icon, color dim (#484f58)
- Colors should complement the dark theme (#0d1117 background) and not clash with atom type colors (task=#58a6ff, fact=#3fb950, event=#d29922, decision=#bc8cff, insight=#f778ba). Claude's discretion on exact palette — the above are starting points.
- Badge is small (16-20px icon, 8-10px font) and positioned alongside the atom type indicator, not replacing it.
- If atom has pinned_tier, show a small pin icon next to the badge.
- Use SolidJS <Show> for conditional rendering. Do NOT early-return from component.

**AtomCard.tsx (EXTEND):**
- Read scores from store: `const atomScore = () => state.scores[props.atom.id]` — NEVER destructure state.
- Apply staleness opacity via inline style: `style={{ ...existingStyles, opacity: String(atomScore()?.opacity ?? 1.0) }}`. Add CSS `transition: opacity 0.5s ease` for gradual visual change.
- Show PriorityBadge only for Tasks and Events (per CONTEXT.md: Facts, Decisions, Insights show staleness only): `<Show when={(props.atom.type === 'task' || props.atom.type === 'event') && atomScore()?.priorityTier}>`. Render `<PriorityBadge tier={atomScore()!.priorityTier!} />` inside the card header area next to the AtomTypeIcon.
- Auto-sort by priority: This is handled at the list level (SectionView/InboxView reads sorted atoms from store), NOT in AtomCard itself. The store or view component should sort atoms by priorityScore descending when rendering lists. Add a sorted atoms memo in store.ts if not already present, or document that views must sort by state.scores[id].priorityScore.

**StatusBar.tsx (EXTEND):**
- Add entropy health badge segment:
  - Read entropy: `const entropyLevel = createMemo(() => state.entropyScore?.level ?? 'green')`
  - Render a colored dot/badge with label: "Healthy" (green), "Warning" (yellow), "Critical" (red)
  - Use CSS classes: `entropy-green`, `entropy-yellow`, `entropy-red` with appropriate colors
  - Position in StatusBar alongside existing persistence/atom count/inbox count segments
- Add inbox cap status indicator:
  - Import inboxCapStatus from store (the createMemo signal)
  - Apply CSS class to the existing inbox count segment: `class={`status-segment inbox-${inboxCapStatus()}`}`
  - CSS: `inbox-ok` = default, `inbox-warning` = yellow/amber text, `inbox-full` = red text
  - Per CONTEXT.md: soft warning is status bar color shift ONLY — no modal, no banner, no badge. Just the color change.
- Add task cap status indicator (same pattern as inbox):
  - Import taskCapStatus from store
  - Show open task count with color coding in a new segment or alongside atom count

**colors.ts (EXTEND):**
- Add tier colors: tierColors object mapping PriorityTier to hex values
- Add entropy colors: entropyColors object { green: '#3fb950', yellow: '#d29922', red: '#f85149' }

**layout.css (EXTEND):**
- Add PriorityBadge styles: .priority-badge with flex layout, small icon, tier-color text
- Add entropy badge styles: .entropy-badge, .entropy-green, .entropy-yellow, .entropy-red
- Add cap status styles: .inbox-ok, .inbox-warning (color: var(--color-warning)), .inbox-full (color: var(--color-danger))
- Add opacity transition to .atom-card: `transition: opacity 0.5s ease`
- Add --color-warning and --color-danger CSS custom properties if not present
  </action>
  <verify>
1. Run `pnpm build` — project builds
2. Run `pnpm lint` — zero errors
3. Run `pnpm dev` — verify in browser: atom cards show opacity based on staleness, task/event atoms show tier badges, status bar shows entropy health badge
  </verify>
  <done>
- PriorityBadge renders correct icon and color per tier (Critical=flame/red, High=arrow-up/orange, Medium=dash/blue, Low=arrow-down/muted, Someday=clock/dim)
- AtomCard opacity reflects staleness score (fresh=1.0, stale=0.6) with smooth transition
- AtomCard shows PriorityBadge for Tasks and Events only
- StatusBar shows entropy health with green/yellow/red color coding
- StatusBar inbox segment color shifts at 80% of cap (green to yellow to red)
  </done>
</task>

<task type="auto">
  <name>Task 2: Cap enforcement in worker handlers + CapEnforcementModal</name>
  <files>
    src/worker/handlers/inbox.ts
    src/worker/handlers/atoms.ts
    src/worker/worker.ts
    src/ui/components/CapEnforcementModal.tsx
    src/app.tsx
  </files>
  <action>
**Worker inbox cap check (src/worker/handlers/inbox.ts — EXTEND):**
- In handleCreateInboxItem (or whatever the inbox creation function is called): BEFORE inserting, call `await writeQueue.flushImmediate()` to ensure accurate count, then read cap config via getCapConfig(), then `const count = await db.inbox.count()`. If count >= capConfig.inboxCap, return 'cap_exceeded' instead of inserting.
- Import getCapConfig from src/worker/handlers/config.ts (created in Plan 02-01).

**Worker task cap check (src/worker/handlers/atoms.ts — EXTEND):**
- In handleCreateAtom: BEFORE inserting, if the atom type is 'task' AND status is 'open' or 'in-progress', call `await writeQueue.flushImmediate()`, read cap config, count existing open/in-progress tasks via Dexie query. If count >= capConfig.taskCap, return 'cap_exceeded'.
- Also check when updating atom status TO 'open' or 'in-progress' (e.g., reopening a completed task).

**Worker dispatch (src/worker/worker.ts — EXTEND):**
- In CREATE_INBOX_ITEM case: check result from handler. If 'cap_exceeded', postMessage a CAP_EXCEEDED response with { capType: 'inbox', cap: capConfig.inboxCap } instead of calling flushAndSendState().
- In CREATE_ATOM case: same pattern for task cap. postMessage CAP_EXCEEDED with { capType: 'task', cap: capConfig.taskCap }.
- CAPT-04 (inbox items must be classified before becoming atoms) is already enforced by Phase 1's CLASSIFY_INBOX_ITEM handler — verify it's still intact, no changes needed.

**CapEnforcementModal.tsx (NEW):**
- Import Show, For from 'solid-js', Portal from 'solid-js/web', state and sendCommand from store
- Render only when state.capExceeded is not null: `<Show when={state.capExceeded !== null}>`
- Use `<Portal>` to render into document.body (bypasses CSS stacking context)
- Modal structure:
  - Full-screen overlay (dark semi-transparent backdrop, no click-to-dismiss)
  - Centered card with title: "Inbox Full" or "Task List Full" depending on state.capExceeded
  - Subtitle: "Free at least one slot to continue." — tone should be "system helping you" not "system blocking you"
  - Scrollable list of items (inbox items if capType='inbox', open tasks if capType='task')
  - Each item row shows: title or first 60 chars of content, created date
  - Quick-action buttons per item:
    - For inbox items: "Classify" (opens inline type selector → dispatches CLASSIFY_INBOX_ITEM), "Discard" (dispatches DELETE_INBOX_ITEM)
    - For tasks: "Complete" (dispatches UPDATE_ATOM with status='done'), "Archive" (dispatches UPDATE_ATOM with status='archived'), "Schedule" (placeholder for future — just mark as waiting for now via UPDATE_ATOM status='waiting')
  - NO close button, NO backdrop click dismiss. The modal can only close when the underlying count drops below the cap. After any action, the STATE_UPDATE from the worker will set capExceeded back to null if count is now below cap.
  - After each action, check: if the action reduced count below cap, the worker's next STATE_UPDATE will clear capExceeded in the store, which will hide the modal via the `<Show>` condition.
- CSS: modal overlay fixed inset-0, z-index via Portal (no z-index needed since Portal mounts to body), dark overlay bg rgba(0,0,0,0.7), centered card max-width 480px, scrollable item list max-height 60vh

**App.tsx (EXTEND):**
- Import and render CapEnforcementModal at the root level (inside the Shell or alongside it). It renders its own Portal so placement doesn't matter for z-index, but it needs access to the store.
- The modal is self-managing via the Show condition — no manual open/close state needed in App.

**layout.css (EXTEND):**
- Add CapEnforcementModal styles: .cap-modal-overlay (fixed, backdrop), .cap-modal (card), .cap-modal-title, .cap-modal-message, .cap-modal-list, .cap-modal-item, .cap-modal-actions, .cap-modal-btn-classify, .cap-modal-btn-discard, .cap-modal-btn-complete, .cap-modal-btn-archive
  </action>
  <verify>
1. Run `pnpm build` — project builds
2. Run `pnpm lint` — zero errors
3. Manual test: create 20+ inbox items rapidly — verify soft warning (yellow status bar) appears at 16+ items, and hard block modal appears at 20 items. Modal should not be dismissable without resolving an item.
  </verify>
  <done>
- Inbox cap enforced: worker rejects CREATE_INBOX_ITEM when count >= inboxCap
- Task cap enforced: worker rejects CREATE_ATOM (type=task, status=open/in-progress) when count >= taskCap
- CAP_EXCEEDED response triggers capExceeded flag in store
- CapEnforcementModal renders via Portal when capExceeded is set
- Modal shows relevant items with quick-action buttons (classify/discard for inbox, complete/archive/schedule for tasks)
- Modal is not dismissable until at least one slot is freed
- Resolving an item triggers STATE_UPDATE which clears capExceeded if count is back below cap
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds — full project builds
2. `pnpm lint` passes — zero errors
3. AtomCard opacity reflects staleness (stale atoms appear faded)
4. Task/Event atoms show PriorityBadge with correct tier icon and color
5. StatusBar shows entropy health badge (green/yellow/red)
6. StatusBar inbox segment turns yellow at 80% cap, red at 100%
7. Inbox cap blocks new items at limit, shows resolution modal
8. Task cap blocks new tasks at limit, shows resolution modal
9. Modal is not dismissable until a slot is freed
</verification>

<success_criteria>
- Per-atom staleness opacity visually distinguishes fresh from stale atoms
- Priority tier badges show correct icons (flame, arrow-up, dash, arrow-down, clock)
- Entropy health is always visible in StatusBar
- Cap enforcement is firm: 80% warning (ambient), 100% block (modal)
- Cap enforcement modal tone is helpful, not punitive
- Both inbox and task caps use identical UX pattern
</success_criteria>

<output>
After completion, create `.planning/phases/02-compute-engine/02-02-SUMMARY.md`
</output>
