---
phase: 02-compute-engine
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/ui/views/ReviewView.tsx
  - src/ui/layout/PageTabStrip.tsx
  - src/ui/layout/MainPane.tsx
  - src/ui/layout/layout.css
  - src/worker/worker.ts
  - src/worker/handlers/atoms.ts
  - src/types/messages.ts
autonomous: false
requirements: [ENTR-08, ENTR-09, ENTR-10]

must_haves:
  truths:
    - "Review tab appears in PageTabStrip and navigates to ReviewView"
    - "ReviewView shows compression prompt candidates one at a time in card-by-card triage"
    - "Each candidate card shows the specific reason (e.g. 'Stale: 45 days since last edit' or 'Orphan: no links')"
    - "User can Archive, Delete, Keep, or Merge each candidate"
    - "Keep action resets staleness (updates updated_at to now)"
    - "Merge action lets user pick a target atom and combines them"
    - "ReviewView shows a rewarding empty state when no candidates remain"
  artifacts:
    - path: "src/ui/views/ReviewView.tsx"
      provides: "Card-by-card compression prompt triage view with four actions"
      exports: ["ReviewView"]
      min_lines: 80
    - path: "src/ui/layout/PageTabStrip.tsx"
      provides: "Extended with Review tab"
      contains: "review"
    - path: "src/ui/layout/MainPane.tsx"
      provides: "Extended with ReviewView route"
      contains: "ReviewView"
  key_links:
    - from: "src/ui/views/ReviewView.tsx"
      to: "src/ui/signals/store.ts"
      via: "reads state.compressionCandidates for candidate list"
      pattern: "compressionCandidates"
    - from: "src/ui/views/ReviewView.tsx"
      to: "src/ui/signals/store.ts"
      via: "dispatches ARCHIVE_ATOM, DELETE_ATOM, UPDATE_ATOM, MERGE_ATOMS via sendCommand"
      pattern: "sendCommand"
    - from: "src/worker/handlers/atoms.ts"
      to: "src/storage/db.ts"
      via: "MERGE_ATOMS transfers links from source to target and deletes source"
      pattern: "merge"
---

<objective>
Build the ReviewView — a dedicated compression prompt page using the same card-by-card triage pattern as InboxView. Users review stale and orphaned atoms one at a time with Archive, Delete, Keep, or Merge actions. The review tab integrates into the existing page tab strip.

Purpose: This is how the system surfaces candidates for compression — making entropy management an active, rewarding practice rather than invisible rot. The card-by-card pattern forces intentional decisions per item.
Output: ReviewView component, Review tab in PageTabStrip, MERGE_ATOMS worker command, merge handler.
</objective>

<execution_context>
@C:/Users/patri/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/patri/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-compute-engine/02-CONTEXT.md
@.planning/phases/02-compute-engine/02-RESEARCH.md
@.planning/phases/02-compute-engine/02-01-SUMMARY.md

@src/ui/views/InboxView.tsx
@src/ui/layout/PageTabStrip.tsx
@src/ui/layout/MainPane.tsx
@src/ui/signals/store.ts
@src/types/config.ts
@src/types/messages.ts
@src/worker/worker.ts
@src/worker/handlers/atoms.ts
@src/ui/layout/layout.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: ReviewView + merge handler + tab integration</name>
  <files>
    src/ui/views/ReviewView.tsx
    src/ui/layout/PageTabStrip.tsx
    src/ui/layout/MainPane.tsx
    src/ui/layout/layout.css
    src/worker/worker.ts
    src/worker/handlers/atoms.ts
    src/types/messages.ts
  </files>
  <action>
**Messages (src/types/messages.ts — EXTEND):**
- Add ARCHIVE_ATOM command: payload { id: string } — sets status to 'archived'
- Add DELETE_ATOM command: payload { id: string } — removes atom permanently
- Add MERGE_ATOMS command: payload { sourceId: string; targetId: string } — transfers links from source to target, deletes source
- These may overlap with existing UPDATE_ATOM/DELETE commands — check existing messages.ts first. If UPDATE_ATOM already handles status changes, ARCHIVE_ATOM can be implemented as UPDATE_ATOM with status='archived'. If DELETE_ATOM already exists, reuse it. Only add MERGE_ATOMS as it's genuinely new.

**Worker handlers (src/worker/handlers/atoms.ts — EXTEND):**
- Add handleMergeAtoms(sourceId: string, targetId: string):
  1. Read both atoms from Dexie
  2. Combine links: target.links = [...new Set([...target.links, ...source.links])] (de-duplicate)
  3. If source has content, append to target content with a separator (e.g., "\n\n---\nMerged from: {source title or first line}")
  4. Update target atom via write queue (triggers changelog)
  5. Delete source atom via write queue (triggers changelog)
  6. Return success

**Worker dispatch (src/worker/worker.ts — EXTEND):**
- Add MERGE_ATOMS case: calls handleMergeAtoms(payload.sourceId, payload.targetId), then flushAndSendState()
- Verify ARCHIVE_ATOM maps to existing UPDATE_ATOM with status='archived' or add a dedicated case

**ReviewView.tsx (NEW):**
Mirror the InboxView triage pattern from Phase 1. Key differences:
- Data source: state.compressionCandidates (not inbox items). Each candidate has { id, reason, staleness }.
- Look up the full atom from state.atoms using candidate.id for display.
- Card-by-card display: show one candidate at a time. Track currentIndex with createSignal.
- Each card shows:
  - Atom type icon + title or first line of content
  - Reason string prominently displayed (e.g., "Stale: 45 days since last edit", "Orphan: no links to active items")
  - Staleness percentage or last-edit date for context
  - Full atom content preview (truncated to ~200 chars with expand option)
- Four action buttons:
  - **Archive** (muted color): dispatches UPDATE_ATOM with status='archived', advances to next card
  - **Delete** (danger color): dispatches DELETE_ATOM with id, advances to next card
  - **Keep** (positive color): dispatches UPDATE_ATOM with updated_at set to Date.now() (resets staleness), advances to next card
  - **Merge** (info color): shows a merge target selector UI:
    - Search-by-title input (similar to type-ahead in InboxView)
    - Filter state.atoms to show matching results (exclude the current candidate)
    - On select target: dispatches MERGE_ATOMS with { sourceId: candidate.id, targetId: selected.id }, advances to next card
    - Cancel button returns to action buttons
- Swipe gestures (mirror InboxView): left = archive, right = keep, up = delete. Same raw touch handler pattern.
- Micro-animation on action completion (same subtle feedback as InboxView triage).
- Progress indicator: "3 of 12 items to review" or a progress bar.
- Empty state (when no candidates or all reviewed):
  - Rewarding message: "All clear! No items need attention." with a checkmark icon
  - Show entropy health summary: current entropy score and level
  - Tone: celebratory but not over-the-top

**PageTabStrip.tsx (EXTEND):**
- Add { id: 'review', label: 'Review' } to the static tabs array
- If compressionCandidates.length > 0, show a subtle count badge on the Review tab (e.g., small number)

**MainPane.tsx (EXTEND):**
- Add `<Match when={state.activePage === 'review'}>` case that renders `<ReviewView />`
- Import ReviewView

**layout.css (EXTEND):**
- Add ReviewView styles mirroring InboxView card styles:
  - .review-view container
  - .review-card with similar dimensions and transitions as inbox triage cards
  - .review-reason with highlighted text style (e.g., slightly different background or italic)
  - .review-actions with four button styles (archive=muted, delete=danger, keep=positive, merge=info)
  - .review-merge-search for the merge target selector
  - .review-empty-state for the celebratory empty state
  - .review-progress for the progress indicator
  - Swipe animation classes matching inbox patterns
  </action>
  <verify>
1. Run `pnpm build` — project builds
2. Run `pnpm lint` — zero errors
3. Run `pnpm dev` — verify Review tab appears in PageTabStrip, clicking it shows ReviewView
4. If compression candidates exist, verify card-by-card triage works with all four actions
5. If no candidates, verify empty state message appears
  </verify>
  <done>
- ReviewView shows compression candidates in card-by-card triage format
- Each card displays atom content, type icon, and specific reason for candidacy
- Archive, Delete, Keep, and Merge actions work correctly
- Keep resets staleness by updating updated_at
- Merge combines links and content from source into target, deletes source
- Swipe gestures mirror InboxView pattern
- Review tab appears in PageTabStrip with optional count badge
- Empty state shows rewarding "all clear" message
- MERGE_ATOMS worker command implemented with link de-duplication
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Phase 2 complete system</name>
  <files>none (verification only)</files>
  <action>
Human verifies the complete Phase 2 compute engine integration. What was built: Rust/WASM priority scoring + staleness decay + entropy health + cap enforcement + compression prompt review page. All atoms now have live computed scores, visual staleness indicators, priority tier badges, entropy health in status bar, inbox/task cap enforcement with resolution modal, and a dedicated Review page for compression prompt candidates.

Verification steps:
1. Open `pnpm dev` in browser
2. **Staleness opacity**: Create a few atoms. Freshly created atoms should be fully opaque. If you can temporarily adjust the half-life or created_at in dev tools, verify that older atoms appear more transparent.
3. **Priority badges**: Create a Task atom — it should show a priority tier badge (likely Medium or Low for a task with no deadline). Create an Event atom — same. Create a Fact atom — should NOT show a priority badge (staleness only).
4. **Entropy health**: Check the StatusBar — there should be a green/yellow/red entropy badge showing system health.
5. **Inbox cap**: Create inbox items until you hit the cap (default 20). At 16 items (80%), the inbox count in status bar should turn yellow. At 20 items, a modal should appear blocking further adds. Classify or discard one item — modal should dismiss.
6. **Review page**: Click the "Review" tab. If there are compression candidates (stale or orphaned atoms), verify card-by-card triage works. Try Archive, Delete, Keep, and Merge actions. If no candidates exist (everything is fresh), verify the empty state message appears.
7. **Overall feel**: The system should feel like it's helping you stay organized, not blocking you. Cap enforcement should be firm but helpful. Staleness should be gradual, not jarring.

Resume signal: Type "approved" or describe any issues to fix.
  </action>
  <verify>User confirms all Phase 2 features work correctly by completing the verification steps above.</verify>
  <done>User has approved the complete Phase 2 compute engine: scoring, staleness, entropy, caps, and review page all function as designed.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. `pnpm lint` passes
3. Review tab navigable and functional
4. Card-by-card triage works with all four actions
5. Merge correctly combines atoms
6. Empty state appears when no candidates
7. Full Phase 2 integration verified by human
</verification>

<success_criteria>
- ReviewView provides the same satisfying triage experience as InboxView
- Each candidate shows a clear, specific reason for being surfaced
- Merge mechanically works: links transferred, content combined, source deleted
- Review tab badge shows candidate count
- The review flow feels rewarding to complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-compute-engine/02-03-SUMMARY.md`
</output>
