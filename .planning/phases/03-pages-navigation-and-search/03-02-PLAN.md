---
phase: 03-pages-navigation-and-search
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/ui/views/pages/TodayPage.tsx
  - src/ui/views/pages/ThisWeekPage.tsx
  - src/ui/views/pages/ActiveProjectsPage.tsx
  - src/ui/views/pages/WaitingPage.tsx
  - src/ui/views/pages/InsightsPage.tsx
  - src/ui/layout/MainPane.tsx
  - src/ui/layout/PageTabStrip.tsx
  - src/ui/components/AtomCard.tsx
  - src/ui/views/AtomDetailView.tsx
autonomous: true
requirements:
  - ORG-04
  - ORG-07
  - ORG-08
  - CAPT-01
  - NAV-03

must_haves:
  truths:
    - "Default pages (Today, This Week, Active Projects, Waiting, Insights) each display the correct atom subset"
    - "User can see task status and change it from the atom card/detail view"
    - "User can set due date and scheduled date on tasks, and event date on events"
    - "Quick capture (Ctrl+N / FAB) works from every page including the five new default pages"
    - "Empty states show compute-engine-driven contextual prompts, not static messages"
  artifacts:
    - path: "src/ui/views/pages/TodayPage.tsx"
      provides: "Today focus list — due today + events today + critical tasks + near-stale atoms"
      min_lines: 30
    - path: "src/ui/views/pages/ActiveProjectsPage.tsx"
      provides: "Projects grouped by section item, each showing next action"
      min_lines: 40
    - path: "src/ui/views/AtomDetailView.tsx"
      provides: "Expanded atom view with editable status, dates, content, and links"
      min_lines: 50
    - path: "src/ui/layout/MainPane.tsx"
      provides: "Updated routing with Match branches for all five default pages"
      contains: "today"
    - path: "src/ui/layout/PageTabStrip.tsx"
      provides: "Updated tab strip with Today, This Week, Active Projects, Waiting, Insights tabs"
      contains: "Today"
  key_links:
    - from: "src/ui/views/pages/TodayPage.tsx"
      to: "src/ui/signals/queries.ts"
      via: "imports todayAtoms createMemo"
      pattern: "todayAtoms"
    - from: "src/ui/layout/MainPane.tsx"
      to: "src/ui/views/pages/TodayPage.tsx"
      via: "Switch/Match routing on state.activePage"
      pattern: "Match.*today"
    - from: "src/ui/components/AtomCard.tsx"
      to: "src/types/messages.ts"
      via: "sendCommand UPDATE_ATOM for status/date changes"
      pattern: "UPDATE_ATOM"
---

<objective>
Default page views, atom detail editing, and task status/date UX.

Purpose: Users see their atoms through GTD-aligned query pages (Today, This Week, Active Projects, Waiting, Insights). Each page renders the correct atom subset from the query engine built in Plan 01. Task status and date editing is accessible from atom cards and the detail view. Quick capture works from all new pages.

Output: Five page components, updated MainPane routing, updated PageTabStrip, atom detail view with editable fields, enhanced AtomCard with status/date editing.
</objective>

<execution_context>
@C:/Users/patri/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/patri/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pages-navigation-and-search/03-RESEARCH.md
@.planning/phases/03-pages-navigation-and-search/03-01-SUMMARY.md

Key existing files to read:
@src/ui/signals/queries.ts (query memos from Plan 01)
@src/ui/components/FilterBar.tsx (filter/sort controls from Plan 01)
@src/ui/signals/store.ts (state shape with selectedAtomId, savedFilters from Plan 01)
@src/ui/layout/MainPane.tsx (current Switch/Match routing — extend with 5 new pages)
@src/ui/layout/PageTabStrip.tsx (current tab strip — add 5 default page tabs)
@src/ui/components/AtomCard.tsx (current card component — enhance with status/date editing)
@src/ui/views/ReviewView.tsx (reference: card-by-card triage pattern for empty states)
@src/types/atoms.ts (Atom types including TaskAtom, EventAtom with date fields)
@src/types/config.ts (AtomScore, EntropyScore, PriorityTier — used in empty state prompts)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Five default page components + empty states + MainPane routing + PageTabStrip</name>
  <files>
    src/ui/views/pages/TodayPage.tsx
    src/ui/views/pages/ThisWeekPage.tsx
    src/ui/views/pages/ActiveProjectsPage.tsx
    src/ui/views/pages/WaitingPage.tsx
    src/ui/views/pages/InsightsPage.tsx
    src/ui/layout/MainPane.tsx
    src/ui/layout/PageTabStrip.tsx
  </files>
  <action>
    **Create `src/ui/views/pages/` directory** with five page components following the same pattern:

    **Common page pattern** (each page follows this structure):
    ```
    Import: For, Show, createSignal from solid-js
    Import: page-specific query memo from queries.ts
    Import: filteredAndSortedAtoms, createFilterState from queries.ts
    Import: FilterBar from components/FilterBar
    Import: AtomCard from components/AtomCard
    Import: state from signals/store
    Import: setSelectedAtomId from signals/store
    Import: useRovingTabindex from hooks/useRovingTabindex  (from Plan 03)

    Component:
    1. Call createFilterState() for local filter state
    2. Create filtered memo: filteredAndSortedAtoms(pageQueryMemo, filterState.filters)
    3. Initialize keyboard nav: useRovingTabindex({ itemCount: () => filteredAtoms().length, onSelect: (i) => setSelectedAtomId(filteredAtoms()[i].id) })
    4. Render:
       - Page header (h2 with page name)
       - FilterBar with appropriate filters enabled
       - Show when={filteredAtoms().length === 0}: empty state component
       - Atom list container div with {...containerProps} from useRovingTabindex
       - For each={filteredAtoms()}: AtomCard with tabindex={itemTabindex(i)}, focused={isItemFocused(i)}, onClick={setSelectedAtomId(atom.id)}
    ```

    **NOTE:** The `useRovingTabindex` hook is created in Plan 03 (which runs in the same wave). If Plan 02 executes first, create a minimal stub at `src/ui/hooks/useRovingTabindex.ts` that returns a no-op implementation, then Plan 03 replaces it with the full implementation. Alternatively, the executor can simply add the keyboard nav wiring after Plan 03 completes. The page components should be structured to accept `tabindex` and `focused` props on AtomCard even if the hook isn't wired yet.

    **TodayPage.tsx:**
    - Uses `todayAtoms` from queries.ts
    - Header: "Today" with atom count badge
    - FilterBar: show status, priority, sort. Hide type filter (Today is cross-type by design).
    - Empty state (compute-engine-driven):
      - If `state.entropyScore?.level === 'green'`: "All clear. Your system is healthy."
      - If stale count > 0: "You have {N} items approaching staleness. Review them?" with link to Review page
      - If no next actions in projects: "Some projects have no next action defined. Check Active Projects."
      - Default: "Nothing due today. Capture something new or review your week."

    **ThisWeekPage.tsx:**
    - Uses `thisWeekAtoms` from queries.ts
    - Header: "This Week" with date range display (Mon-Sun)
    - FilterBar: show all filters except section
    - Empty state: "Your week is clear. Good time to plan ahead or review stale items."

    **ActiveProjectsPage.tsx:**
    - Uses `activeProjectAtoms` from queries.ts (returns grouped data)
    - Different rendering: For each project group, render a section header with project name and atom count, then For each atom in group, render AtomCard. The FIRST atom in each group is highlighted as "Next Action" with a subtle badge/indicator.
    - FilterBar: show status, priority, sort. Section filter not needed (already project-scoped).
    - Empty state: "No active projects. Create a project in the sidebar and assign tasks to it."

    **WaitingPage.tsx:**
    - Uses `waitingAtoms` from queries.ts
    - Header: "Waiting" with count
    - Each AtomCard shows a staleness alert if `state.scores[atom.id]?.staleness > 0.5` — render a small "Long wait" badge next to the time
    - FilterBar: show sort only (all items are waiting tasks by definition)
    - Empty state: "Nothing waiting. If you're blocked on something, mark a task as 'waiting'."

    **InsightsPage.tsx:**
    - Uses `insightAtoms` from queries.ts
    - Header: "Insights" with count
    - FilterBar: show sort and date range only
    - Empty state: "No insights captured yet. When you have an idea worth remembering, capture it as an Insight."

    **Update `src/ui/layout/MainPane.tsx`:**
    - Import all five page components
    - Import AtomDetailView (created in Task 2)
    - Add Match branches for `state.activePage === 'today'`, `'this-week'`, `'active-projects'`, `'waiting'`, `'insights'`
    - Add a Show block: when `state.selectedAtomId !== null`, render AtomDetailView as a side panel or overlay (controlled by selectedAtomId state)
    - Keep existing inbox, all, review, section-* routes

    **Update `src/ui/layout/PageTabStrip.tsx`:**
    - Update `staticTabs` array to include the five default pages:
      ```
      { id: 'inbox', label: 'Inbox' },
      { id: 'today', label: 'Today' },
      { id: 'this-week', label: 'This Week' },
      { id: 'active-projects', label: 'Active Projects' },
      { id: 'waiting', label: 'Waiting' },
      { id: 'insights', label: 'Insights' },
      { id: 'all', label: 'All Items' },
      ```
    - Keep the Review tab and section-derived tabs
    - Add saved filter tabs: read `state.savedFilters` and append them as tabs with id `'filter-{filter.id}'` and label `filter.name` (enables Plan 04 saved filter feature to render immediately once filters are saved)

    **IMPORTANT design directive from CONTEXT.md:** "UI should feel like the AI assistant of the future." Empty states must use compute-engine data (state.entropyScore, state.compressionCandidates, state.scores) to generate contextual suggestions, NOT static placeholder text. Each page's empty state should reference real system state.

    **CSS:** Add styles for page components to the global stylesheet or inline. Follow existing pattern (dark theme, var(--bg-*), var(--text-*)). Page header should be consistent across all pages. Filter chips should be compact.
  </action>
  <verify>
    Run `npx tsc --noEmit`. Start dev server (`pnpm dev`), click each page tab — verify correct atoms display (or empty state if no matching atoms). Verify capture shortcut (Ctrl+N) still works on each page. Verify PageTabStrip shows all tabs including saved filters.
  </verify>
  <done>
    Five default pages render correct atom subsets. PageTabStrip shows Today, This Week, Active Projects, Waiting, Insights tabs. MainPane routes to correct page component. Empty states show compute-engine-driven contextual prompts. Quick capture works from all pages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Atom detail view + task status/date editing UI</name>
  <files>
    src/ui/views/AtomDetailView.tsx
    src/ui/components/AtomCard.tsx
  </files>
  <action>
    **1. Create `src/ui/views/AtomDetailView.tsx`:**

    A detail panel/view that shows a single atom's full information when `state.selectedAtomId` is set.

    Import: `Show, Switch, Match, createSignal, createMemo` from `solid-js`
    Import: `state, sendCommand, setSelectedAtomId` from `../signals/store`
    Import: `AtomTypeIcon` from `../components/AtomTypeIcon`
    Import: `PriorityBadge` from `../components/PriorityBadge`

    Component renders:
    - **Header**: Atom type icon + title (editable on click — inline text input, saves on blur/Enter via UPDATE_ATOM)
    - **Close button**: calls `setSelectedAtomId(null)`
    - **Status section** (ORG-07):
      - For tasks: A row of status buttons (open, in-progress, waiting, done, cancelled). Active status has highlight class. Click sends `UPDATE_ATOM` with new status.
      - For non-tasks: Show current status as read-only badge
    - **Date section** (ORG-08):
      - For tasks: Due date input (`<input type="date">`) and Scheduled date input. Pre-fill from existing values. On change, convert to timestamp and send `UPDATE_ATOM` with `{ dueDate: timestamp }` or `{ scheduledDate: timestamp }`.
      - For events: Event date input. Same pattern.
      - For other types: No date section
    - **Content section**: Full content display. For now, render as pre-formatted text (Markdown rendering is nice-to-have, not required). Consider a simple `<textarea>` for editing — save on blur via UPDATE_ATOM.
    - **Metadata**: Created at, updated at, section/section item names (resolved from state), link count
    - **Priority/staleness**: Show PriorityBadge and staleness value if available from state.scores
    - **Backlinks placeholder**: An empty `<div id="backlinks-section">` with text "Backlinks section — added in Plan 04"
    - **Tags placeholder**: An empty `<div id="tags-section">` with text "Tags section — added in Plan 04"

    Layout: Render as a slide-in panel from the right side (position: fixed, right: 0, top: 0, width: 400px on desktop, full-width on mobile). Dark background overlay behind it. Click overlay or press Escape to close.

    **Status change flow (ORG-07):**
    When user clicks a status button:
    1. Immediately send `UPDATE_ATOM` command with `{ id, changes: { status: newStatus } }`
    2. The Worker processes the mutation, sends STATE_UPDATE, store reconciles, and the detail view updates reactively
    3. No optimistic update needed — the reactive store handles it

    **Date change flow (ORG-08):**
    When user changes a date input:
    1. Parse the date string to Unix ms timestamp
    2. Send `UPDATE_ATOM` with `{ id, changes: { dueDate: timestamp } }` (or scheduledDate/eventDate)
    3. If date is cleared (empty string), send `UPDATE_ATOM` with `{ dueDate: undefined }` to remove

    **2. Enhance `src/ui/components/AtomCard.tsx`:**

    Add to existing AtomCard (minimal changes):
    - Show due date if atom is task type and has dueDate: render a small `<span class="atom-card-due">Due {formatted date}</span>` after the status badge. If overdue (dueDate < now), add class `overdue` (red text).
    - Show event date if atom is event type and has eventDate: render `<span class="atom-card-date">{formatted date}</span>`.
    - On click, instead of just toggling expanded state, also call `setSelectedAtomId(props.atom.id)` to open the detail panel. Remove the inline expanded toggle (detail view replaces it).
    - Import `setSelectedAtomId` from `../signals/store`

    **Date formatting helper** (add to AtomCard or shared utils):
    ```typescript
    function formatDate(ts: number): string {
      return new Date(ts).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }
    ```

    **CSS additions:**
    - `.atom-detail-panel`: fixed right panel, z-index above main content
    - `.atom-detail-overlay`: semi-transparent background overlay
    - `.status-button`: compact pill button, highlight when active
    - `.atom-card-due.overdue`: red text color
    - Follow existing dark theme patterns
  </action>
  <verify>
    Run `npx tsc --noEmit`. Start dev server, create a task atom, click on it — verify detail panel opens. Change status via status buttons — verify atom updates. Set a due date — verify it appears on the atom card. Press Escape — verify panel closes. Test Ctrl+N from detail view — verify capture overlay still opens.
  </verify>
  <done>
    AtomDetailView renders as a slide-in panel showing full atom info with editable title, status buttons (tasks), date inputs (tasks/events), and content. AtomCard shows due date and event date inline. Clicking an atom card opens the detail panel. Status changes via button clicks dispatch UPDATE_ATOM. Date changes via input fields dispatch UPDATE_ATOM. Escape closes the panel. Quick capture works from all contexts.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. All five default pages display correct atom subsets (test with seed data)
3. Empty states show contextual prompts using compute engine data
4. Task status can be changed from detail view; change reflects in all page views
5. Due date can be set on tasks; overdue dates show in red on atom cards
6. PageTabStrip shows Today, This Week, Active Projects, Waiting, Insights, All Items, section tabs, Review
7. Ctrl+N capture works from every page
8. Atom detail panel opens on card click, closes on Escape or overlay click
</verification>

<success_criteria>
- Five GTD-aligned pages render correct atom subsets without page-specific state storage
- Tasks can be moved through status lifecycle (open -> in-progress -> waiting -> done/cancelled)
- Dates can be set and cleared on tasks and events
- Empty states are compute-engine-driven (reference entropy, staleness, compression data)
- Quick capture accessible from all pages (CAPT-01 verification)
- PageTabStrip includes all default tabs and saved filter tabs
</success_criteria>

<output>
After completion, create `.planning/phases/03-pages-navigation-and-search/03-02-SUMMARY.md`
</output>
