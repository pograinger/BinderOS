---
phase: 03-pages-navigation-and-search
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/ui/components/TagInput.tsx
  - src/ui/components/BacklinksPanel.tsx
  - src/ui/views/AtomDetailView.tsx
  - src/ui/layout/PageTabStrip.tsx
  - src/ui/components/AtomCard.tsx
  - src/ui/components/MentionAutocomplete.tsx
autonomous: true
requirements:
  - NAV-05
  - NAV-06
  - NAV-07

must_haves:
  truths:
    - "Backlinks section on atom detail view shows all atoms that link to the current one"
    - "User can add freeform tags and a GTD context to any atom"
    - "User can save current filter configuration as a named page that appears as a tab"
    - "User can create inline links to other atoms using @mention syntax in content"
  artifacts:
    - path: "src/ui/components/TagInput.tsx"
      provides: "Tag input with autocomplete for freeform tags + GTD context dropdown"
      min_lines: 40
    - path: "src/ui/components/BacklinksPanel.tsx"
      provides: "Collapsible backlinks section showing atoms that link to current atom"
      min_lines: 25
    - path: "src/ui/components/MentionAutocomplete.tsx"
      provides: "@mention autocomplete for inline linking in atom content"
      min_lines: 30
  key_links:
    - from: "src/ui/components/BacklinksPanel.tsx"
      to: "src/ui/signals/store.ts"
      via: "createMemo filtering state.atoms by links targeting current atom"
      pattern: "state\\.atoms\\.filter.*links"
    - from: "src/ui/components/TagInput.tsx"
      to: "src/types/messages.ts"
      via: "sendCommand UPDATE_ATOM with tags/context changes"
      pattern: "UPDATE_ATOM.*tags"
    - from: "src/ui/views/AtomDetailView.tsx"
      to: "src/ui/components/BacklinksPanel.tsx"
      via: "renders BacklinksPanel with current atom ID"
      pattern: "BacklinksPanel"
    - from: "src/ui/layout/PageTabStrip.tsx"
      to: "src/ui/signals/store.ts"
      via: "reads state.savedFilters to render custom filter tabs"
      pattern: "state\\.savedFilters"
---

<objective>
Tags, backlinks, saved filters, and inline linking.

Purpose: Complete the cross-cutting organization layer. Users can tag atoms for categorization, see backlinks showing relationships, save custom filter views as permanent tabs, and create inline links between atoms using @mention syntax. This finishes all NAV-05, NAV-06, NAV-07 requirements.

Output: TagInput component, BacklinksPanel component, MentionAutocomplete component, updated AtomDetailView with tags/backlinks sections, saved filter functionality in FilterBar, custom page tabs in PageTabStrip.
</objective>

<execution_context>
@C:/Users/patri/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/patri/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pages-navigation-and-search/03-RESEARCH.md
@.planning/phases/03-pages-navigation-and-search/03-01-SUMMARY.md
@.planning/phases/03-pages-navigation-and-search/03-02-SUMMARY.md
@.planning/phases/03-pages-navigation-and-search/03-03-SUMMARY.md

Key existing files to read:
@src/ui/views/AtomDetailView.tsx (from Plan 02 — add tag/backlinks sections to replace placeholders)
@src/ui/signals/store.ts (state.atoms for backlinks computation, state.savedFilters for tabs)
@src/ui/layout/PageTabStrip.tsx (from Plan 02 — verify saved filter tabs render correctly)
@src/ui/components/FilterBar.tsx (from Plan 01 — add "Save as page" button)
@src/types/atoms.ts (tags, context fields from Plan 01 migration)
@src/types/messages.ts (SAVE_FILTER, DELETE_FILTER commands from Plan 01)
@src/storage/db.ts (SavedFilter interface from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tag input + GTD context + backlinks panel + atom detail integration</name>
  <files>
    src/ui/components/TagInput.tsx
    src/ui/components/BacklinksPanel.tsx
    src/ui/views/AtomDetailView.tsx
    src/ui/components/AtomCard.tsx
  </files>
  <action>
    **1. Create `src/ui/components/TagInput.tsx`:**

    A component for managing freeform tags and GTD context on an atom.

    Props: `{ atomId: string; tags: string[]; context: string | null | undefined }`

    Structure:
    - **Tags section**:
      - Render existing tags as removable chips (small pills with × button)
      - Text input for adding new tags. On Enter or comma, add the tag (trimmed, lowercased, no duplicates).
      - Autocomplete dropdown: on input, filter all unique tags from `state.atoms.flatMap(a => a.tags ?? [])` that match the input prefix. Show up to 5 suggestions. Arrow down to navigate, Enter to select.
      - On tag add/remove: send `UPDATE_ATOM` with updated `tags` array: `sendCommand({ type: 'UPDATE_ATOM', payload: { id: props.atomId, changes: { tags: newTags } } })`
    - **GTD Context section**:
      - A dropdown/select with predefined GTD contexts: @home, @office, @errands, @calls, @computer, @agenda, @anywhere
      - Allow custom context entry (input field that becomes a context)
      - Current context shown as a highlighted chip
      - On change: send `UPDATE_ATOM` with `{ context: newContext }` (or `null` to clear)

    Autocomplete behavior:
    - Collect all unique tags across all atoms: `createMemo(() => [...new Set(state.atoms.flatMap(a => a.tags ?? []))])`
    - Filter by current input value (prefix match, case-insensitive)
    - Show dropdown below input when suggestions exist and input is focused
    - Keyboard: ArrowDown/Up to navigate suggestions, Enter to select, Escape to close dropdown

    **2. Create `src/ui/components/BacklinksPanel.tsx`:**

    A collapsible section showing all atoms that link to the current atom (NAV-05 per CONTEXT.md: "Collapsible 'Linked from (N)' section at the bottom of atom detail view. Collapsed by default, expand to see linking atoms as compact cards").

    Props: `{ atomId: string }`

    Implementation:
    - Compute backlinks as a createMemo: `state.atoms.filter(a => a.links.some(l => l.targetId === props.atomId))`
    - IMPORTANT: use `props.atomId` (not destructured) inside the memo for SolidJS reactivity
    - Render:
      - Header: "Linked from ({count})" — clickable to toggle expanded state
      - Collapsed by default (`createSignal(false)`)
      - When expanded: render each backlinking atom as a compact card:
        - AtomTypeIcon + title + relative time
        - Click navigates to that atom: `setSelectedAtomId(backlinkAtom.id)`
      - When no backlinks: show "No other atoms link to this one." in muted text

    **3. Update `src/ui/views/AtomDetailView.tsx`:**

    Replace the placeholder sections from Plan 02:

    - Replace `<div id="tags-section">Tags section — added in Plan 04</div>` with:
      ```tsx
      <TagInput
        atomId={state.selectedAtomId!}
        tags={selectedAtom()?.tags ?? []}
        context={selectedAtom()?.context ?? null}
      />
      ```
    - Replace `<div id="backlinks-section">Backlinks section — added in Plan 04</div>` with:
      ```tsx
      <BacklinksPanel atomId={state.selectedAtomId!} />
      ```
    - Import TagInput and BacklinksPanel

    **4. Update `src/ui/components/AtomCard.tsx`:**

    Show tags on atom cards (compact):
    - After the time display, if `props.atom.tags?.length > 0`, render the first 2-3 tags as tiny chips: `<span class="atom-card-tag">{tag}</span>`. If more than 3 tags, show "+N" badge.
    - Show GTD context as a small indicator: `<span class="atom-card-context">{props.atom.context}</span>` (only if context is set)

    **CSS:**
    - `.tag-chip`: small pill, bg secondary, removable (× on hover)
    - `.tag-input`: compact inline input
    - `.tag-autocomplete`: dropdown below input, z-index above card content
    - `.context-chip`: small highlighted pill with @ prefix
    - `.backlinks-header`: clickable, cursor pointer, flex between label and count
    - `.backlinks-panel`: collapsible with max-height transition
    - `.backlink-item`: compact row similar to AtomCard but smaller
    - `.atom-card-tag`: tiny inline chip (12px font, 2px padding)
    - `.atom-card-context`: muted small text
  </action>
  <verify>
    Run `npx tsc --noEmit`. Open an atom detail view — verify TagInput renders with add/remove capability. Add a tag — verify it persists (appears after STATE_UPDATE). Verify autocomplete shows existing tags. Set a GTD context — verify it appears. Verify BacklinksPanel shows correct backlinks count. Create a link from atom A to atom B, then view atom B — verify A appears in backlinks. Verify tags show on AtomCard.
  </verify>
  <done>
    TagInput allows adding/removing freeform tags with autocomplete from existing tags across all atoms. GTD context dropdown allows setting action contexts (@home, @office, etc.). BacklinksPanel shows all atoms linking to the current one, collapsed by default. Tags and contexts display on atom cards. All changes persist via UPDATE_ATOM commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Saved filters + @mention inline linking + save-as-page UX</name>
  <files>
    src/ui/components/FilterBar.tsx
    src/ui/components/MentionAutocomplete.tsx
    src/ui/layout/PageTabStrip.tsx
    src/ui/views/AtomDetailView.tsx
  </files>
  <action>
    **1. Update `src/ui/components/FilterBar.tsx`:**

    Add a "Save as page" button to the filter bar.

    - At the end of the filter bar (right side), add a button: "Save as page" (small, secondary style)
    - On click: show a small inline input for the page name (replaces the button temporarily)
    - On name submit (Enter or blur with non-empty value):
      1. Generate a UUID for the saved filter: `crypto.randomUUID()`
      2. Capture current filter state snapshot: `{ ...currentFilterState }`
      3. Send `SAVE_FILTER` command: `sendCommand({ type: 'SAVE_FILTER', payload: { id, name, filter: filterSnapshot } })`
      4. Revert the inline input back to the button
    - The saved filter will appear as a tab in PageTabStrip (handled by existing savedFilters state and PageTabStrip rendering from Plan 02)

    **2. Verify/update `src/ui/layout/PageTabStrip.tsx`:**

    Ensure saved filter tabs render correctly (this should already work from Plan 02, but verify and fix if needed):
    - After static tabs + section tabs + review tab, append saved filter tabs:
      ```tsx
      <For each={state.savedFilters}>
        {(filter) => (
          <button
            class={`page-tab${state.activePage === `filter-${filter.id}` ? ' active' : ''}`}
            onClick={() => handleTabClick(`filter-${filter.id}`)}
          >
            {filter.name}
            <button
              class="filter-tab-delete"
              onClick={(e) => { e.stopPropagation(); sendCommand({ type: 'DELETE_FILTER', payload: { id: filter.id } }); }}
              title="Remove saved filter"
            >
              x
            </button>
          </button>
        )}
      </For>
      ```
    - Add a Match branch in MainPane for `state.activePage.startsWith('filter-')`:
      - Extract filter ID from page name
      - Look up the SavedFilter from `state.savedFilters`
      - Render a generic filtered page view using `filteredAndSortedAtoms` from queries.ts with the saved filter's config
      - This may require adding a `SavedFilterPage` component or rendering inline

    **3. Create `src/ui/components/MentionAutocomplete.tsx`:**

    @mention autocomplete for inline linking in atom content (per CONTEXT.md: "@mention syntax in atom content, type @atomName to create a link with autocomplete showing existing atoms").

    Props: `{ value: string; onValueChange: (value: string) => void; onLinkCreated: (targetId: string) => void }`

    Implementation approach (simple for v1 per RESEARCH.md Pitfall 7):
    - Wrap a `<textarea>` with mention detection
    - On input, detect if the cursor is immediately after an `@` character followed by text
    - If `@` detected: extract the query text after `@`, search `state.atoms` by title (prefix match, case-insensitive), show dropdown below textarea (anchored to textarea bottom, not cursor position — v1 simplification per RESEARCH.md)
    - Dropdown shows up to 8 matching atoms with AtomTypeIcon + title
    - On selection (click or Enter):
      1. Replace `@query` in the textarea value with `@{atom.title}` (or a link marker like `[@{atom.title}](atom:{atom.id})`)
      2. Call `onLinkCreated(selectedAtom.id)` — the parent component should add an AtomLink to the current atom's links array via UPDATE_ATOM
    - Keyboard: ArrowDown/Up to navigate suggestions, Enter to select, Escape to dismiss
    - When no `@` is being typed: textarea behaves normally

    **4. Update `src/ui/views/AtomDetailView.tsx`:**

    Replace the content textarea with MentionAutocomplete:
    - Import MentionAutocomplete
    - Replace the plain `<textarea>` for content editing with:
      ```tsx
      <MentionAutocomplete
        value={selectedAtom()?.content ?? ''}
        onValueChange={(newContent) => {
          sendCommand({ type: 'UPDATE_ATOM', payload: { id: state.selectedAtomId!, changes: { content: newContent } } });
        }}
        onLinkCreated={(targetId) => {
          // Add a link from current atom to target atom
          const currentLinks = selectedAtom()?.links ?? [];
          const newLink = { targetId, relationshipType: 'mentions', direction: 'forward' as const };
          if (!currentLinks.some(l => l.targetId === targetId)) {
            sendCommand({
              type: 'UPDATE_ATOM',
              payload: {
                id: state.selectedAtomId!,
                changes: {
                  links: [...currentLinks, newLink],
                },
              },
            });
          }
        }}
      />
      ```
    - Content changes should be debounced (300ms) to avoid sending UPDATE_ATOM on every keystroke. Use a local createSignal for the textarea value and a createEffect with setTimeout for debounced saves.

    **CSS:**
    - `.save-filter-btn`: small secondary button, right-aligned in filter bar
    - `.save-filter-input`: inline text input replacing button, compact
    - `.filter-tab-delete`: tiny x button on saved filter tabs, visible on hover
    - `.mention-autocomplete`: wrapper around textarea with dropdown
    - `.mention-dropdown`: positioned below textarea, list of atom suggestions
    - `.mention-item`: compact row with icon + title, hover highlight
  </action>
  <verify>
    Run `npx tsc --noEmit`. Open a page with filters active, click "Save as page" — verify saved filter appears as a new tab. Click the saved filter tab — verify it loads the correct filtered view. Delete a saved filter tab — verify it disappears. Open atom detail, type @mention — verify autocomplete shows matching atoms. Select an atom — verify link is created (check backlinks on target atom). Verify content changes are saved (debounced).
  </verify>
  <done>
    "Save as page" button in FilterBar creates persistent saved filters that appear as custom tabs in PageTabStrip. Saved filter tabs load the correct filtered atom view. Delete button removes saved filters. @mention autocomplete in atom content allows creating inline links with atom suggestions. Link creation is reflected in backlinks panel of target atom. Content editing is debounced to avoid excessive mutations.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Tags can be added, removed, and autocompleted from existing tags across atoms
3. GTD context can be set and cleared; context appears on atom cards
4. Backlinks panel shows correct count; clicking a backlink navigates to that atom
5. "Save as page" creates a custom filter tab; clicking it shows filtered results
6. Saved filter tabs persist across page reloads (stored in Dexie)
7. @mention autocomplete shows atom suggestions and creates links on selection
8. Created links appear in target atom's backlinks panel
9. Content changes debounced and persisted
</verification>

<success_criteria>
- Backlinks visible on each atom showing all linking atoms (NAV-05)
- Freeform tags + GTD context field on atoms, with autocomplete (NAV-06)
- Custom filter definitions saved as named pages appearing as tabs (NAV-07)
- @mention inline linking creates bidirectional discoverability (backlinks)
- All tag, context, filter, and link data persists in IndexedDB via Dexie
</success_criteria>

<output>
After completion, create `.planning/phases/03-pages-navigation-and-search/03-04-SUMMARY.md`
</output>
