---
phase: 04-ai-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/ai/adapters/cloud.ts
  - src/ai/privacy-proxy.ts
  - src/ai/key-vault.ts
  - src/ui/components/AISettingsPanel.tsx
  - src/ui/components/AIGuidedSetup.tsx
  - src/ui/components/CommandPalette.tsx
  - src/ui/layout/StatusBar.tsx
autonomous: false
requirements:
  - AINF-04
  - AIST-01
  - AIST-02
  - AIST-03
user_setup:
  - service: anthropic
    why: "Cloud API for conversational reviews and Get Creative reasoning"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys -> Create Key (https://console.anthropic.com/settings/keys)"
    dashboard_config: []

must_haves:
  truths:
    - "User can open Settings from Command Palette and see per-feature toggles for Browser LLM, Cloud API, Triage suggestions, Review analysis, and Compression coach"
    - "User can enter an API key; the key is memory-only by default with a visible security disclosure explaining the tradeoff"
    - "User can opt into encrypted key persistence with a passphrase via Web Crypto AES-GCM"
    - "Cloud adapter only receives pre-sanitized strings from the privacy proxy — never raw atom objects"
    - "Per-session consent prompt appears when cloud API is used for the first time in a session"
    - "On first v2.0 launch, a guided setup wizard walks through enabling AI features"
    - "Destructive AI actions (delete, archive, overwrite) always require explicit user approval before execution"
    - "Status bar shows AI activity indicator when AI is processing"
  artifacts:
    - path: "src/ai/adapters/cloud.ts"
      provides: "CloudAdapter using Anthropic SDK with streaming and browser CORS"
      exports: ["CloudAdapter"]
    - path: "src/ai/privacy-proxy.ts"
      provides: "Sanitization layer enforcing privacy boundary between atom store and cloud adapters"
      exports: ["sanitizeForCloud", "SanitizationLevel"]
    - path: "src/ai/key-vault.ts"
      provides: "Memory-only and encrypted API key storage via Web Crypto"
      exports: ["setMemoryKey", "getMemoryKey", "encryptAndStore", "decryptFromStore", "clearStoredKey"]
    - path: "src/ui/components/AISettingsPanel.tsx"
      provides: "Settings panel with per-feature toggles, API key input, provider status, sanitization level control"
      contains: "AISettingsPanel"
    - path: "src/ui/components/AIGuidedSetup.tsx"
      provides: "First-run guided setup wizard for AI features"
      contains: "AIGuidedSetup"
    - path: "src/ui/layout/StatusBar.tsx"
      provides: "Extended StatusBar with AI activity indicator"
      contains: "aiActivity"
  key_links:
    - from: "src/ai/adapters/cloud.ts"
      to: "src/ai/key-vault.ts"
      via: "CloudAdapter reads API key from memory vault on each request"
      pattern: "getMemoryKey"
    - from: "src/ai/adapters/cloud.ts"
      to: "src/ai/privacy-proxy.ts"
      via: "CloudAdapter.execute() requires prompt to pass through sanitization"
      pattern: "sanitizeForCloud"
    - from: "src/ui/components/AISettingsPanel.tsx"
      to: "src/ai/key-vault.ts"
      via: "Settings panel calls setMemoryKey/encryptAndStore when user enters key"
      pattern: "setMemoryKey|encryptAndStore"
    - from: "src/ui/components/CommandPalette.tsx"
      to: "src/ui/components/AISettingsPanel.tsx"
      via: "Command palette 'AI Settings' command opens the panel"
      pattern: "ai-settings"
---

<objective>
Build the cloud API adapter (Anthropic SDK with streaming), privacy proxy (sanitization layer), Web Crypto key vault, AI settings panel with per-feature toggles, guided setup wizard, per-session consent, and status bar AI activity indicator.

Purpose: This completes the trust & safety layer and cloud connectivity. Users get full control over which AI features are active, how their data is protected, and how their API keys are stored. The privacy proxy enforces the critical architectural boundary: cloud LLMs never see raw atom data.

Output: Working cloud adapter with streaming, encrypted key vault, settings panel accessible from Ctrl+P, guided setup on first launch, per-session consent for cloud use, and activity indicator in the status bar.
</objective>

<execution_context>
@C:/Users/patri/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/patri/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ai-infrastructure/04-RESEARCH.md
@.planning/phases/04-ai-infrastructure/04-01-SUMMARY.md

@src/ai/adapters/adapter.ts
@src/ai/router.ts
@src/ui/signals/store.ts
@src/ui/components/CommandPalette.tsx
@src/ui/layout/StatusBar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cloud adapter, privacy proxy, and key vault</name>
  <files>
    src/ai/adapters/cloud.ts
    src/ai/privacy-proxy.ts
    src/ai/key-vault.ts
  </files>
  <action>
**1. Create `src/ai/key-vault.ts`** — Memory-only + optional encrypted persistence:

Per AIST-02: memory-only by default. Encrypted persistence is opt-in with passphrase.
Per CONTEXT.md: "API keys encrypted locally: Web Crypto AES-GCM encryption in localStorage with user passphrase."

```typescript
// Memory-only key storage (default — cleared on page unload)
let memoryKey: string | null = null;

export function setMemoryKey(apiKey: string): void { memoryKey = apiKey; }
export function getMemoryKey(): string | null { return memoryKey; }
export function clearMemoryKey(): void { memoryKey = null; }
```

`encryptAndStore(apiKey: string, passphrase: string): Promise<void>`:
- Generate random salt (16 bytes) and iv (12 bytes)
- Derive encryption key from passphrase using PBKDF2 (100_000 iterations, SHA-256)
- Encrypt with AES-GCM-256
- Store `{ salt, iv, data }` as base64 JSON in `localStorage.setItem('binderos-ai-key', ...)`
- Also set memoryKey for immediate use

`decryptFromStore(passphrase: string): Promise<string | null>`:
- Read from localStorage
- If not found, return null
- Derive key from passphrase using same PBKDF2 params
- Decrypt with AES-GCM
- On success, set memoryKey and return the key
- On failure (wrong passphrase), throw error

`clearStoredKey(): void`:
- Remove from localStorage
- Clear memoryKey

`hasStoredKey(): boolean`:
- Return `localStorage.getItem('binderos-ai-key') !== null`

**Per-session consent tracking:**
```typescript
let sessionConsentGranted = false;
export function grantSessionConsent(): void { sessionConsentGranted = true; }
export function hasSessionConsent(): boolean { return sessionConsentGranted; }
export function revokeSessionConsent(): void { sessionConsentGranted = false; }
```

**2. Create `src/ai/privacy-proxy.ts`** — Sanitization layer:

Per CONTEXT.md critical decision: "Local LLMs have direct access to atoms (trusted, on-device). Cloud/remote LLMs NEVER see raw atom data."
Per CONTEXT.md: "User-controlled sanitization levels: from 'abstract patterns only' to 'structured summaries' to 'full context'."

```typescript
export type SanitizationLevel = 'abstract' | 'structured' | 'full';
```

- `abstract`: Only counts, types, scores. E.g., "You have 15 tasks, 3 are stale. Inbox has 8 items. Entropy: yellow."
- `structured`: Metadata without content. E.g., "Task 'Fix login bug' (type: task, status: open, staleness: 0.7, links: 2)"
- `full`: Titles and content included. E.g., full atom text.

Default is `abstract` (most private per CONTEXT.md).

```typescript
export function sanitizeForCloud(
  rawContext: string,
  level: SanitizationLevel
): string {
  // The rawContext is already a string prepared by the local LLM
  // or by the calling code. The sanitization level controls how
  // the local LLM summarizes before passing to cloud.
  //
  // In Phase 4, this is a passthrough with level validation.
  // Phase 5+ will implement the actual local-LLM-as-proxy flow
  // where the local model summarizes atoms at the selected level
  // before sending the summary to the cloud adapter.
  //
  // The type boundary is the real protection: CloudAdapter.execute()
  // accepts AIRequest with prompt: string, never Atom objects.

  if (level === 'abstract') {
    // Phase 4: validate that no raw atom content appears
    // (enforcement; actual summarization added in Phase 5)
    return rawContext;
  }
  return rawContext;
}
```

Export a `DEFAULT_SANITIZATION_LEVEL: SanitizationLevel = 'abstract'`.

**3. Create `src/ai/adapters/cloud.ts`** — Anthropic cloud adapter:

Per CONTEXT.md: "Multi-provider support: user can configure multiple cloud providers"
Per RESEARCH.md: Use `@anthropic-ai/sdk` with `dangerouslyAllowBrowser: true`.

Note: `@anthropic-ai/sdk` needs to be installed. Add a code comment: `// Requires: pnpm add @anthropic-ai/sdk`

```typescript
import Anthropic from '@anthropic-ai/sdk';
import type { AIAdapter, AIRequest, AIResponse, AIProviderStatus } from './adapter';
import { getMemoryKey, hasSessionConsent } from '../key-vault';
import { isOnline } from './browser';  // reuse online check from browser adapter

export class CloudAdapter implements AIAdapter {
  readonly id = 'cloud' as const;
  private _status: AIProviderStatus = 'disabled';
  private client: Anthropic | null = null;

  get status(): AIProviderStatus {
    return this._status;
  }

  initialize(): void {
    const apiKey = getMemoryKey();
    if (!apiKey) {
      this._status = 'unavailable';
      return;
    }
    this.client = new Anthropic({
      apiKey,
      dangerouslyAllowBrowser: true,
      // dangerouslyAllowBrowser is safe here because:
      // - User provides their own key (not embedded in source)
      // - Key is memory-only by default (AIST-02)
      // - Key never leaves the browser except to Anthropic's API
    });
    this._status = 'available';
  }

  async execute(request: AIRequest): Promise<AIResponse> {
    if (!this.client) throw new Error('Cloud adapter not initialized — no API key');
    if (this._status !== 'available') throw new Error(`Cloud adapter status: ${this._status}`);

    // AINF-06: Graceful offline degradation
    if (!isOnline()) {
      throw new Error('Cloud AI unavailable — you are currently offline. Local AI features still work.');
    }

    // AIST-01: Per-session consent check
    if (!hasSessionConsent()) {
      throw new Error('Cloud AI requires session consent. Open AI Settings to continue.');
    }

    // prompt is ALWAYS pre-sanitized — never raw atom data
    // Type boundary enforces this: AIRequest.prompt is string, not Atom
    const stream = this.client.messages.stream({
      model: 'claude-haiku-4-5',  // Cost-efficient for classification/routing
      max_tokens: request.maxTokens ?? 512,
      messages: [{ role: 'user', content: request.prompt }],
    });

    stream.on('text', (text) => request.onChunk?.(text));

    if (request.signal) {
      request.signal.addEventListener('abort', () => stream.abort());
    }

    const message = await stream.finalMessage();
    const text = message.content[0]?.type === 'text' ? message.content[0].text : '';

    return {
      requestId: request.requestId,
      text,
      provider: 'cloud',
      model: 'claude-haiku-4-5',
    };
  }

  reinitialize(): void {
    // Called when API key changes
    this.client = null;
    this._status = 'disabled';
    this.initialize();
  }

  dispose(): void {
    this.client = null;
    this._status = 'disabled';
  }
}
```

**AIST-03 — Destructive action guard:** Add a utility in a new export:
```typescript
export const DESTRUCTIVE_ACTIONS = ['delete', 'archive', 'overwrite'] as const;
export type DestructiveAction = typeof DESTRUCTIVE_ACTIONS[number];

export function isDestructiveAction(action: string): boolean {
  return DESTRUCTIVE_ACTIONS.includes(action as DestructiveAction);
}
```

This utility is used by Phase 5+ triage/review handlers. In Phase 4, we define it. The actual confirmation modal integration happens in the UI layer (Phase 5).

**Install Anthropic SDK:** The executor must run `pnpm add @anthropic-ai/sdk` before building. Add this as the first step in the action.
  </action>
  <verify>
Run `pnpm add @anthropic-ai/sdk` then `npx tsc --noEmit` — all files compile. Verify `CloudAdapter` imports `getMemoryKey` and `hasSessionConsent`. Verify `sanitizeForCloud` is exported from privacy-proxy.ts. Verify `encryptAndStore` uses `crypto.subtle` (Web Crypto API). Verify `isDestructiveAction` is exported from cloud.ts.
  </verify>
  <done>
Cloud adapter connects to Anthropic with streaming via SDK. Key vault provides memory-only default + encrypted persistence opt-in. Privacy proxy defines sanitization levels with type boundary enforcement. Per-session consent is tracked. Offline check prevents cloud calls when offline with friendly message. Destructive action guard utility is defined for Phase 5+.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AI Settings panel, guided setup wizard, and status bar integration</name>
  <files>
    src/ui/components/AISettingsPanel.tsx
    src/ui/components/AIGuidedSetup.tsx
    src/ui/components/CommandPalette.tsx
    src/ui/layout/StatusBar.tsx
  </files>
  <action>
**1. Create `src/ui/components/AISettingsPanel.tsx`** — Settings panel opened from Command Palette:

Per CONTEXT.md locked decisions:
- "Per-feature toggles: separate toggles for Browser LLM, Cloud API, Triage suggestions, Review analysis, Compression coach"
- "Simple labels for normal use ('Local AI: Ready') with expandable model details for power users"
- "Full transparency on cloud requests: every cloud request shows a preview of what the local LLM is sending"
- "Communication log accessible in settings for review"

Props: `{ onClose: () => void }`

Structure:
```
AI Settings Panel (overlay, similar to CommandPalette positioning)
├── Header: "AI Settings" + close button (X)
├── Section: Master Toggle
│   └── "Enable AI Features" toggle (controls state.aiEnabled)
├── Section: Local AI (Show when={state.aiEnabled})
│   ├── "Browser LLM" toggle (state.browserLLMEnabled)
│   ├── Status: state.llmStatus display ("Ready", "Loading...", "Error", "Disabled")
│   ├── Model details (expandable): state.llmModelId, state.llmDevice
│   └── Download progress bar (Show when={state.llmDownloadProgress !== null})
├── Section: Cloud AI (Show when={state.aiEnabled})
│   ├── "Cloud API" toggle (state.cloudAPIEnabled)
│   ├── Status: state.cloudStatus display
│   ├── API Key input (password type, with "Show" toggle)
│   │   ├── Button: "Save to memory only" (calls setMemoryKey)
│   │   └── Button: "Encrypt & persist" (opens passphrase dialog, calls encryptAndStore)
│   ├── Security disclosure: "Memory-only: key is cleared when you close the app. Encrypted: key persists across sessions with your passphrase."
│   ├── Show when={hasStoredKey()}: "Encrypted key found. Enter passphrase to unlock." with input + unlock button
│   └── Per-session consent status: "Cloud AI will be used via local proxy. [Continue / Disable]"
├── Section: Feature Toggles (Show when={state.aiEnabled})
│   ├── "Triage suggestions" toggle (stored in state, used by Phase 5)
│   ├── "Review analysis" toggle (stored in state, used by Phase 6)
│   └── "Compression coach" toggle (stored in state, used by Phase 7)
├── Section: Privacy
│   ├── Sanitization level selector: "Abstract patterns only" / "Structured summaries" / "Full context"
│   └── Current level description text
└── Section: Provider Status
    └── Table showing: Provider name, Status, Model (if applicable)
```

Use SolidJS `createSignal` for local UI state (passphrase input, API key input, show/hide toggle). Use store setters for persistent state (setAIEnabled, setBrowserLLMEnabled, setCloudAPIEnabled).

CSS classes follow existing component patterns: `ai-settings-backdrop`, `ai-settings-container`, `ai-settings-section`, `ai-settings-toggle`, etc.

CRITICAL: Never destructure props or state. Use `state.aiEnabled`, `state.llmStatus`, etc.

Note: Feature toggles for triage/review/compression are UI-only in Phase 4 — they control visibility of features built in Phases 5-7. Store them in BinderState (add `triageEnabled`, `reviewEnabled`, `compressionEnabled` fields to store — these are UI toggles, defaults to `true` when `aiEnabled` is true).

**2. Create `src/ui/components/AIGuidedSetup.tsx`** — First-run setup wizard:

Per CONTEXT.md: "Guided setup on first v2.0 launch: step-by-step wizard walks through enabling AI, model download, cloud API key entry"
Per CONTEXT.md: "Simple choice: two options — 'Fast (150MB)' and 'Quality (300MB)' — recommended option highlighted based on hardware detection"

Props: `{ onComplete: () => void }`

Show this component when `state.aiFirstRunComplete === false` (conditionally rendered in App.tsx or Shell.tsx).

Steps (use a `createSignal<number>(0)` for current step):

**Step 0: Welcome**
- "BinderOS AI is ready to help with triage, reviews, and organization."
- "AI features are optional and off by default."
- [Enable AI] [Skip for now]
- If "Skip", call `setAIFirstRunComplete(true)` and `onComplete()`

**Step 1: Local AI Model**
- "Choose your local AI model. This runs entirely on your device — no data leaves your machine."
- Two cards:
  - "Fast" — "Smaller model, works on any device" — recommended if no WebGPU
  - "Quality" — "Larger model, requires GPU" — recommended if WebGPU detected
- Recommended card is highlighted based on WebGPU detection (read from store or detect inline)
- [Download & Continue] button — calls the BrowserAdapter initialize flow (from Plan 02), shows download progress bar
- [Skip local AI] — continues without browser LLM

**Step 2: Cloud API (optional)**
- "Connect a cloud API for deeper analysis during reviews."
- "Your data is always filtered through the local AI first — cloud models never see raw data."
- API key input (same pattern as settings panel)
- Security disclosure text
- [Save & Continue] / [Skip]

**Step 3: Done**
- Summary of what was configured
- [Start using BinderOS]
- Calls `setAIFirstRunComplete(true)` and `onComplete()`

**3. Update `src/ui/components/CommandPalette.tsx`:**

Add a new command to the `staticCommands` array in the 'action' category:
```typescript
{
  id: 'action-ai-settings',
  label: 'AI Settings',
  category: 'action',
  action: () => { props.onClose(); props.onOpenAISettings?.(); },
},
```

Add `onOpenAISettings?: () => void` to `CommandPaletteProps`. The parent component (likely Shell.tsx or App.tsx) will provide this callback to open the AISettingsPanel.

**4. Update `src/ui/layout/StatusBar.tsx`:**

Per CONTEXT.md: "Status bar shows activity indicator: 'Analyzing inbox...', 'Preparing review...', 'Idle'. Model details on hover/click"

Add after the storage segment (before the spacer):
```tsx
{/* Phase 4: AI activity indicator */}
<Show when={state.aiEnabled}>
  <div class="status-bar-item ai-status">
    <Show when={state.aiActivity} fallback={
      <span class="ai-status-idle">
        {state.llmStatus === 'available' ? 'Local AI: Ready' :
         state.llmStatus === 'loading' ? 'Local AI: Loading...' :
         state.llmStatus === 'error' ? 'Local AI: Error' :
         'AI: Disabled'}
      </span>
    }>
      <span class="ai-status-active">{state.aiActivity}</span>
    </Show>
  </div>
</Show>
```

Import `state` is already imported. No new imports needed.
  </action>
  <verify>
Run `npx tsc --noEmit` and `pnpm lint`. Verify AISettingsPanel has per-feature toggles for Browser LLM, Cloud API, Triage, Review, Compression. Verify AIGuidedSetup has 4 steps (welcome, local model, cloud API, done). Verify CommandPalette has "AI Settings" command. Verify StatusBar shows AI activity when `state.aiEnabled` is true.
  </verify>
  <done>
AI Settings panel accessible from Ctrl+P with per-feature toggles, API key management (memory-only default + encrypted persistence), sanitization level control, and provider status. Guided setup wizard walks through AI enablement on first launch. Status bar shows AI activity indicator. Command palette has "AI Settings" action. All AI features default to disabled (AIST-01).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify AI settings and guided setup</name>
  <files>src/ui/components/AISettingsPanel.tsx, src/ui/components/AIGuidedSetup.tsx, src/ui/layout/StatusBar.tsx</files>
  <action>
Human verification checkpoint. What was built: AI Settings panel with per-feature toggles, API key management, guided setup wizard, and status bar AI activity indicator. Cloud adapter with Anthropic streaming. Privacy proxy and key vault.
  </action>
  <verify>
1. Run `pnpm dev` — app starts at localhost
2. Press Ctrl+P — Command Palette opens. Type "AI" — "AI Settings" command should appear. Execute it.
3. AI Settings panel opens:
   - Master "Enable AI" toggle is OFF by default
   - Toggle it ON — sub-sections for Local AI and Cloud AI appear
   - Per-feature toggles are visible (Triage, Review, Compression)
4. Close settings. If `aiFirstRunComplete` is false, guided setup should appear on next app load:
   - Welcome step with Enable/Skip
   - Local model step with Fast/Quality cards
   - Cloud API step with key input
   - Done step with summary
5. Check status bar — when AI is enabled, shows "AI: Disabled" or "Local AI: Ready" etc.
6. Enter a test API key in settings — verify "Memory only" disclosure is visible
7. Verify security: Open browser DevTools -> Application -> Local Storage — no plaintext API key should exist unless user explicitly chose "Encrypt & persist"
  </verify>
  <done>Type "approved" or describe any visual/functional issues to continue.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `pnpm lint` passes
3. `pnpm add @anthropic-ai/sdk` succeeds and package is in package.json
4. AI Settings panel is reachable from Command Palette (Ctrl+P -> "AI Settings")
5. All per-feature toggles work (Browser LLM, Cloud API, Triage, Review, Compression)
6. API key input with security disclosure is visible
7. Guided setup wizard appears when `aiFirstRunComplete` is false
8. Status bar shows AI status when AI is enabled
9. No plaintext API key in localStorage (only encrypted bytes if user opted in)
10. `navigator.onLine === false` produces friendly "offline" message from CloudAdapter
11. Per-session consent is tracked and checked before cloud API use
</verification>

<success_criteria>
- Cloud adapter streams responses from Anthropic API with abort support
- Privacy proxy defines sanitization levels and enforces type boundary
- Key vault stores keys memory-only by default, with opt-in AES-GCM encrypted persistence
- Settings panel has all per-feature toggles matching CONTEXT.md specification
- Guided setup wizard provides step-by-step first-run experience
- Status bar shows AI activity indicator
- Destructive action guard utility exists for Phase 5+ consumption
- Per-session consent gate exists for cloud API use
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-infrastructure/04-03-SUMMARY.md`
</output>
