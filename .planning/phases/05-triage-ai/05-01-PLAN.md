---
phase: 05-triage-ai
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/components/AIOrb.tsx
  - src/ui/components/AIRadialMenu.tsx
  - src/ui/layout/Shell.tsx
  - src/ui/layout/layout.css
autonomous: true
requirements: [AIUX-01, AIUX-02]

must_haves:
  truths:
    - "A floating orb is visible on every page when any AI adapter is available"
    - "Tapping the orb opens a radial menu with 4-5 segments (Triage, Review, Compress, Discuss, Settings)"
    - "The segment relevant to the current page is highlighted as the primary action (larger/brighter)"
    - "The orb animates between states: idle pulse, thinking spin, streaming open, error flash with 'Triage failed — tap to retry' message"
    - "The orb remains visible but suppresses its menu when overlays (capture, search, cloud preview) are open"
  artifacts:
    - path: "src/ui/components/AIOrb.tsx"
      provides: "Floating orb component with state machine and context-aware positioning"
      min_lines: 60
    - path: "src/ui/components/AIRadialMenu.tsx"
      provides: "Radial menu with 4-5 segments, primary action highlight, and action callbacks"
      min_lines: 40
    - path: "src/ui/layout/layout.css"
      provides: "Orb CSS animations (idle pulse, thinking spin, streaming open, error flash) and radial menu layout"
      contains: "@keyframes orbIdlePulse"
  key_links:
    - from: "src/ui/layout/Shell.tsx"
      to: "src/ui/components/AIOrb.tsx"
      via: "JSX render as last child in .shell div"
      pattern: "<AIOrb"
    - from: "src/ui/components/AIOrb.tsx"
      to: "src/ui/signals/store.ts"
      via: "reads state.activePage and anyAIAvailable()"
      pattern: "state\\.activePage|anyAIAvailable"
    - from: "src/ui/components/AIOrb.tsx"
      to: "src/ui/components/AIRadialMenu.tsx"
      via: "conditionally renders menu when orb is expanded"
      pattern: "<AIRadialMenu"
    - from: "src/ui/components/AIOrb.tsx"
      to: "src/ui/signals/store.ts"
      via: "click-in-error calls startTriageInbox() for retry"
      pattern: "startTriageInbox"
---

<objective>
Build the floating AI orb and radial menu — the always-visible AI entry point for BinderOS.

Purpose: The orb is the single AI trigger point (CONTEXT.md locked decision). It must be visible on every page, styled as a "binder ring that opens" (brand identity), with CSS animation states and a context-aware radial menu.

Output: AIOrb.tsx, AIRadialMenu.tsx, Shell.tsx integration, orb/menu CSS in layout.css.
</objective>

<execution_context>
@C:/Users/patri/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/patri/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-triage-ai/05-CONTEXT.md
@.planning/phases/05-triage-ai/05-RESEARCH.md
@src/ui/layout/Shell.tsx
@src/ui/layout/layout.css
@src/ui/signals/store.ts
@src/app.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AIOrb component with state machine and CSS animations</name>
  <files>src/ui/components/AIOrb.tsx, src/ui/layout/layout.css</files>
  <action>
Create `src/ui/components/AIOrb.tsx` as a SolidJS component:

**Orb state machine** — `type OrbState = 'idle' | 'thinking' | 'streaming' | 'error' | 'expanded'`. Use `createSignal<OrbState>('idle')`. The orb reads `anyAIAvailable()` from store — if no adapter available, return null (don't render). Wrap entire output in `<Show when={anyAIAvailable()}>`.

**Context-aware positioning** — Read `state.activePage` to determine CSS custom properties `--orb-bottom` and `--orb-right`. Default: bottom-right (above FAB). For 'inbox' page, position slightly higher to avoid overlap with triage card actions. Use `createEffect` to set these properties on the orb container element via `style` prop. Animate position changes via CSS `transition: bottom 0.3s ease-out, right 0.3s ease-out`.

**Orb visual** — The orb is a 48px circle with a ring border styled to evoke a binder ring:
- Inner circle (`.ai-orb-ring`) uses `border: 2px solid var(--accent)` with `box-shadow` glow
- `conic-gradient` background on the ring creates the "opening ring" visual — a gap in the ring that widens/narrows based on state
- `position: fixed`, `z-index: 100`, `border-radius: 50%`, `cursor: pointer`

**State-driven CSS classes** — Apply `ai-orb--{state}` class. Each state has a `@keyframes` animation in layout.css:
- `ai-orb--idle`: `.ai-orb-ring` has `animation: orbIdlePulse 3s ease-in-out infinite` — gentle box-shadow pulse between 8px and 16px spread (matches existing celebratePulse pattern from layout.css)
- `ai-orb--thinking`: `.ai-orb-ring` has `animation: orbThinkingSpin 1s linear infinite` with `border-style: dashed` — dashed ring rotates
- `ai-orb--streaming`: `.ai-orb-ring` has combined `orbStreamingOpen 0.5s ease-out forwards` and slow spin. Use `conic-gradient(var(--accent) 0%, transparent 60%)` to create the "ring opening" visual with a gap
- `ai-orb--error`: `.ai-orb-ring` has `animation: orbErrorFlash 1.5s ease-out forwards` — border-color flashes from `var(--status-error)` red back to `var(--accent)` blue
- `ai-orb--expanded`: Ring fully open (larger gap in conic-gradient), triggers radial menu render

**Click handler** — On click, toggle between 'idle' and 'expanded'. If in 'error' state, clicking calls `startTriageInbox()` (imported from `../signals/store`) to retry, AND resets orbState to 'idle'. This implements the CONTEXT.md locked decision: "Retry is always available from the orb's error state."

**Error message element** — When `orbState() === 'error'`, render a `<span class="ai-orb-error-msg">Triage failed — tap to retry</span>` element positioned below the orb via CSS (`position: absolute; top: 100%; left: 50%; transform: translateX(-50%); white-space: nowrap`). Style: `font-size: 12px; color: var(--status-error); background: var(--bg-primary); padding: 2px 8px; border-radius: 4px; pointer-events: none; animation: fadeIn 0.3s ease-out`. Add `.ai-orb-error-msg` styles to layout.css in the `/* Phase 5: AI Orb */` section.

**Overlay suppression** — Accept an `isOverlayOpen` prop. When true, hide the radial menu and scale the orb to a subtle 24px dot (CSS `transform: scale(0.5)` with transition). The orb remains visible but non-interactive for the menu.

**Export orbState setter** — Export `setOrbState` so the triage pipeline (Plan 03) can set 'thinking', 'streaming', 'error' states from outside the component. Use a module-level signal pattern (same as Shell.tsx's `setShowAISettings`).

**CSS in layout.css** — Add all orb CSS at the end of layout.css in a clearly commented `/* Phase 5: AI Orb */` section. Include:
- `.ai-orb` positioning, sizing, z-index, transition
- `.ai-orb-ring` border, box-shadow, border-radius
- All 5 state class variants with their `@keyframes`
- `@keyframes orbIdlePulse`, `orbThinkingSpin`, `orbStreamingOpen`, `orbErrorFlash`
- `.ai-orb--overlay-active` for the scaled-down dot state
- `aria-label="AI assistant"` and `role="button"` for accessibility

Do NOT install any animation library. Use pure CSS @keyframes consistent with existing layout.css patterns.
  </action>
  <verify>
- `pnpm lint` passes with no new errors
- `npx tsc --noEmit` compiles without errors
- AIOrb.tsx exports `AIOrb` component and `setOrbState` function
- layout.css contains all 4 @keyframes animations
  </verify>
  <done>
AIOrb component renders a fixed-position glowing binder-ring orb with 5 CSS animation states, context-aware positioning based on activePage, and overlay suppression. All animations are pure CSS @keyframes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AIRadialMenu component and integrate orb into Shell</name>
  <files>src/ui/components/AIRadialMenu.tsx, src/ui/layout/Shell.tsx, src/ui/layout/layout.css</files>
  <action>
**AIRadialMenu.tsx** — Create a new SolidJS component for the radial/pie menu:

Props: `{ primaryAction: string; onAction: (action: string) => void; onClose: () => void }`.

Menu items: 5 segments — 'triage', 'review', 'compress', 'discuss', 'settings'. Each has a label and a small icon (use inline SVG, consistent with PriorityBadge pattern). Render as a `<div class="ai-radial-menu">` container with 5 `<button class="ai-radial-item">` children.

**CSS positioning for radial layout** — Use CSS nth-child transforms to position items around the orb center in a circle (per RESEARCH.md Pattern 3). For 5 items at ~72deg intervals: use `translateX/translateY` combinations to place them in a semi-circle above/around the orb. The exact pixel offsets for 5 items at radius 70px:
- Item 1 (top): `transform: translateY(-70px)`
- Item 2 (top-right): `transform: translate(56px, -42px)` (cos/sin of 72deg increments)
- Item 3 (right): `transform: translate(67px, 22px)`
- Item 4 (left): `transform: translate(-67px, 22px)`
- Item 5 (top-left): `transform: translate(-56px, -42px)`

**Primary action highlight** — The item matching `props.primaryAction` gets class `ai-radial-item--primary`: larger size (56px vs 48px), `background: var(--accent)`, `color: var(--bg-primary)`, `font-weight: 600`.

**Action callbacks:**
- 'triage': calls `props.onAction('triage')` — wired in Plan 03 to trigger triageInbox()
- 'review': calls `props.onAction('review')` — stub for Phase 6
- 'compress': calls `props.onAction('compress')` — stub for Phase 7
- 'discuss': calls `props.onAction('discuss')` — stub, will wire to AIQuestionFlow in Plan 04
- 'settings': imports and calls `setShowAISettings(true)` from Shell.tsx, then `props.onClose()`

**Entry animation** — Items scale in from 0 to 1 with staggered delays (50ms per item): CSS `animation: radialItemIn 0.2s ease-out forwards` with `animation-delay` via nth-child.

**Close on outside click** — Add a click handler on the `.ai-radial-menu` backdrop that calls `props.onClose()`.

**Shell.tsx integration:**
1. Import `AIOrb` into Shell.tsx
2. Render `<AIOrb isOverlayOpen={showAISettings() || !state.aiFirstRunComplete || state.pendingCloudRequest !== null} />` as the last child of the `.shell` div, AFTER the StatusBar and BEFORE the Phase 4 overlays
3. The `isOverlayOpen` prop suppresses the menu when other overlays are active

**layout.css additions** — Add radial menu CSS in the `/* Phase 5: AI Orb */` section:
- `.ai-radial-menu` positioning (absolute, above orb)
- `.ai-radial-item` base styles and nth-child transforms
- `.ai-radial-item--primary` highlight styles
- `@keyframes radialItemIn` scale animation
- Staggered animation delays via nth-child

Do NOT use any third-party radial menu library. Pure CSS transforms.
  </action>
  <verify>
- `pnpm lint` passes
- `npx tsc --noEmit` compiles
- Shell.tsx renders `<AIOrb>` component
- AIRadialMenu.tsx renders 5 items with correct CSS classes
- Clicking 'settings' in the radial menu opens the AI settings panel
  </verify>
  <done>
Radial menu renders 5 context-aware segments around the orb with CSS transform positioning. The primary action is highlighted based on activePage. Shell.tsx renders the orb as a permanent fixture. Settings action opens AISettingsPanel.
  </done>
</task>

</tasks>

<verification>
1. Open the app in browser — the orb should be visible at bottom-right on every page
2. Click the orb — radial menu appears with 5 segments
3. Navigate to Inbox — "Triage" segment should be highlighted as primary
4. Navigate to All Items — "Compress" segment should be highlighted
5. Open capture overlay (Ctrl+N) — orb should shrink to a dot, menu hidden
6. Close overlay — orb returns to normal size
7. Click "Settings" in radial menu — AI Settings panel opens
</verification>

<success_criteria>
- Orb visible on all pages when any AI adapter is available
- Radial menu opens/closes on orb tap
- Context-aware primary action changes per page
- 4 CSS animation states work (idle pulse, thinking spin, streaming open, error flash)
- Orb suppresses to dot during overlays
- Zero new lint or TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-triage-ai/05-01-SUMMARY.md`
</output>
