---
phase: 05-triage-ai
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/atoms.ts
  - src/types/changelog.ts
  - src/types/messages.ts
  - src/storage/db.ts
  - src/storage/migrations/v3.ts
  - src/storage/ai-settings.ts
  - src/worker/worker.ts
  - src/worker/handlers/inbox.ts
  - src/ui/signals/store.ts
  - src/ui/components/AtomCard.tsx
autonomous: true
requirements: [AIUX-05]

must_haves:
  truths:
    - "Atoms classified by AI display a persistent AI badge (small icon/dot with tooltip 'AI-suggested')"
    - "AI-triggered mutations are tagged with source: 'ai' in the changelog"
    - "AI settings (aiEnabled, browserLLMEnabled, cloudAPIEnabled, aiFirstRunComplete) persist across page reloads via Dexie config table"
    - "The CLASSIFY_INBOX_ITEM command accepts an optional aiSourced field that tags the resulting atom"
    - "Existing atoms without aiSourced field continue to work (backward-compatible Dexie v3 migration)"
  artifacts:
    - path: "src/types/atoms.ts"
      provides: "Optional aiSourced: boolean field on BaseAtomFields"
      contains: "aiSourced"
    - path: "src/types/changelog.ts"
      provides: "Optional source: 'ai' | 'user' field on MutationLogEntry"
      contains: "source.*ai.*user"
    - path: "src/storage/migrations/v3.ts"
      provides: "Dexie v3 migration adding aiSourced index on atoms table"
      contains: "version(3)"
    - path: "src/storage/ai-settings.ts"
      provides: "loadAISettings() and saveAISettings() using Dexie config table"
      exports: ["loadAISettings", "saveAISettings"]
    - path: "src/ui/components/AtomCard.tsx"
      provides: "AI badge rendering when atom.aiSourced === true"
      contains: "aiSourced"
  key_links:
    - from: "src/worker/handlers/inbox.ts"
      to: "src/storage/changelog.ts"
      via: "passes source: 'ai' to appendMutation when aiSourced is true"
      pattern: "source.*ai"
    - from: "src/worker/worker.ts"
      to: "src/storage/ai-settings.ts"
      via: "loads AI settings in INIT handler, includes in READY payload"
      pattern: "loadAISettings"
    - from: "src/ui/signals/store.ts"
      to: "src/storage/ai-settings.ts"
      via: "initializes AI state from READY payload aiSettings"
      pattern: "aiSettings"
---

<objective>
Extend the atom schema, changelog, and Dexie database to support AI-sourced content tagging, and implement persistent AI settings storage.

Purpose: AI-sourced mutations must be tracked and visually marked (AIUX-05). AI settings must persist across reloads (deferred from Phase 4). These schema extensions are foundational for the triage pipeline (Plan 03).

Output: Extended types, Dexie v3 migration, AI settings persistence, AI badge on AtomCard, CLASSIFY_INBOX_ITEM aiSourced support.
</objective>

<execution_context>
@C:/Users/patri/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/patri/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-triage-ai/05-RESEARCH.md
@src/types/atoms.ts
@src/types/changelog.ts
@src/types/messages.ts
@src/storage/db.ts
@src/storage/migrations/v2.ts
@src/storage/classification-log.ts
@src/worker/worker.ts
@src/worker/handlers/inbox.ts
@src/ui/signals/store.ts
@src/ui/components/AtomCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend atom/changelog schemas, add Dexie v3 migration, create AI settings persistence</name>
  <files>src/types/atoms.ts, src/types/changelog.ts, src/types/messages.ts, src/storage/db.ts, src/storage/migrations/v3.ts, src/storage/ai-settings.ts</files>
  <action>
**1. Extend BaseAtomFields in src/types/atoms.ts:**
Add `aiSourced: z.boolean().optional()` to the BaseAtomFields object. This is an additive field — existing atoms will have `undefined` which is handled by the optional() validator. Place it after the existing `context` field with a comment `// Phase 5: true if this atom was classified by AI`.

**2. Extend MutationLogEntrySchema in src/types/changelog.ts:**
Add two optional fields to the Zod schema:
- `source: z.enum(['user', 'ai']).optional()` — Phase 5: AI-sourced mutations tagged
- `aiRequestId: z.string().optional()` — Phase 5: links back to the AI request that triggered this

These are optional fields on an existing Zod schema. No Dexie index needed for changelog (stores JSON blobs indexed by id/atomId/timestamp/lamportClock).

**3. Extend CLASSIFY_INBOX_ITEM command in src/types/messages.ts:**
Add `aiSourced?: boolean` to the CLASSIFY_INBOX_ITEM payload type. This is how the triage pipeline (Plan 03) will tell the worker to tag the resulting atom as AI-sourced.

**4. Create Dexie v3 migration at src/storage/migrations/v3.ts:**
Follow the exact pattern from v2.ts. The migration:
- `db.version(3).stores({...})` with the atoms table adding `aiSourced` to its index list: `'&id, type, status, sectionId, sectionItemId, updated_at, *links, *tags, context, aiSourced'`
- All other tables remain identical to their v2 definitions
- `.upgrade(tx => { return tx.table('atoms').toCollection().modify(atom => { if (atom.aiSourced === undefined) atom.aiSourced = false; }); })`
- This sets `aiSourced: false` on all existing atoms for clean querying

**5. Register v3 migration in src/storage/db.ts:**
Import `applyV3Migration` from `./migrations/v3` and call it after `applyV2Migration(db)`.

**6. Create src/storage/ai-settings.ts:**
Follow the classification-log.ts pattern for using the Dexie config table:

```typescript
import { db } from './db';
import { writeQueue } from './write-queue';

const AI_SETTINGS_KEY = 'ai-settings';

export interface AISettings {
  aiEnabled: boolean;
  browserLLMEnabled: boolean;
  cloudAPIEnabled: boolean;
  aiFirstRunComplete: boolean;
  triageEnabled: boolean;
  reviewEnabled: boolean;
  compressionEnabled: boolean;
}

export async function loadAISettings(): Promise<AISettings | null> {
  const entry = await db.config.get(AI_SETTINGS_KEY);
  return entry ? (entry.value as AISettings) : null;
}

export function saveAISettings(settings: Partial<AISettings>): void {
  writeQueue.enqueue(async () => {
    const existing = await db.config.get(AI_SETTINGS_KEY);
    const merged = { ...(existing?.value ?? {}), ...settings };
    await db.config.put({ key: AI_SETTINGS_KEY, value: merged });
  });
}
```

This runs in the worker where `db` and `writeQueue` are available.
  </action>
  <verify>
- `npx tsc --noEmit` compiles without errors in src/ files
- `pnpm lint` passes
- `src/storage/migrations/v3.ts` exists and exports `applyV3Migration`
- `src/storage/ai-settings.ts` exists and exports `loadAISettings`, `saveAISettings`
- CLASSIFY_INBOX_ITEM payload type includes optional `aiSourced` field
  </verify>
  <done>
Atom schema has optional aiSourced field indexed in Dexie v3. Changelog has optional source/aiRequestId fields. CLASSIFY_INBOX_ITEM accepts aiSourced flag. AI settings persistence module ready for worker integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire AI settings into worker INIT/READY, add AI badge to AtomCard, and tag AI mutations in inbox handler</name>
  <files>src/worker/worker.ts, src/worker/handlers/inbox.ts, src/ui/signals/store.ts, src/ui/components/AtomCard.tsx</files>
  <action>
**1. Load AI settings in worker INIT handler (src/worker/worker.ts):**
Import `loadAISettings` from `../../storage/ai-settings`.
In the `case 'INIT':` block, after the existing data loads (atoms, inboxItems, etc.), call:
```typescript
const aiSettings = await loadAISettings();
```
Include `aiSettings` in the READY payload: add `aiSettings: aiSettings ?? null` to the `self.postMessage({ type: 'READY', payload: { ... } })` call.

**Update the Response type** in messages.ts: Add `aiSettings?: { aiEnabled: boolean; browserLLMEnabled: boolean; cloudAPIEnabled: boolean; aiFirstRunComplete: boolean; triageEnabled: boolean; reviewEnabled: boolean; compressionEnabled: boolean } | null` to the READY payload type.

**2. Save AI settings on toggle (src/worker/worker.ts):**
Add a new command type `SAVE_AI_SETTINGS` to the Command union in messages.ts:
```typescript
| { type: 'SAVE_AI_SETTINGS'; payload: Partial<AISettings> }
```
Handle it in worker.ts by calling `saveAISettings(command.payload)`. Import `saveAISettings` from the ai-settings module. Import the `AISettings` type.

**3. Initialize store from persisted AI settings (src/ui/signals/store.ts):**
In the `case 'READY':` handler, after the existing reconcile calls, check for `response.payload.aiSettings`:
```typescript
if (response.payload.aiSettings) {
  const s = response.payload.aiSettings;
  if (s.aiEnabled !== undefined) setState('aiEnabled', s.aiEnabled);
  if (s.browserLLMEnabled !== undefined) setState('browserLLMEnabled', s.browserLLMEnabled);
  if (s.cloudAPIEnabled !== undefined) setState('cloudAPIEnabled', s.cloudAPIEnabled);
  if (s.aiFirstRunComplete !== undefined) setState('aiFirstRunComplete', s.aiFirstRunComplete);
  if (s.triageEnabled !== undefined) setState('triageEnabled', s.triageEnabled);
  if (s.reviewEnabled !== undefined) setState('reviewEnabled', s.reviewEnabled);
  if (s.compressionEnabled !== undefined) setState('compressionEnabled', s.compressionEnabled);
}
```

Update the existing AI setter functions (setAIEnabled, setBrowserLLMEnabled, etc.) to also send `SAVE_AI_SETTINGS` command to the worker so changes persist:
```typescript
export function setAIEnabled(enabled: boolean): void {
  setState('aiEnabled', enabled);
  sendCommand({ type: 'SAVE_AI_SETTINGS', payload: { aiEnabled: enabled } });
}
```
Apply this pattern to ALL existing AI setter functions: setBrowserLLMEnabled, setCloudAPIEnabled, setAIFirstRunComplete, setTriageEnabled, setReviewEnabled, setCompressionEnabled.

**4. Tag AI mutations in inbox handler (src/worker/handlers/inbox.ts):**
In the `handleClassifyInboxItem` function (or equivalent classify handler), check if the command payload has `aiSourced: true`. If so:
- Set `aiSourced: true` on the new atom being created from the inbox item
- Pass `source: 'ai'` to the `appendMutation()` call for the changelog entry

If `aiSourced` is not set or false, pass `source: 'user'` (or omit, since it's optional — existing behavior unchanged).

**5. Add AI badge to AtomCard (src/ui/components/AtomCard.tsx):**
Add a small AI badge indicator rendered conditionally when `props.atom.aiSourced === true`. Follow the existing PriorityBadge pattern:
- A small inline SVG icon (a tiny sparkle or robot head, 12x12px) with `var(--accent)` color
- CSS class `ai-badge` with `display: inline-flex; align-items: center; margin-left: 4px`
- Tooltip via `title="AI-suggested"` attribute
- Position it next to the atom type icon or in the card header area
- Subtle appearance: small enough to notice if you look, but doesn't dominate (per CONTEXT.md)

Add the `.ai-badge` CSS to layout.css in the Phase 5 section (or inline styles following AtomCard's existing pattern).
  </action>
  <verify>
- `npx tsc --noEmit` compiles
- `pnpm lint` passes
- Worker READY payload includes aiSettings field
- SAVE_AI_SETTINGS command exists in messages.ts Command type
- AtomCard renders AI badge when atom.aiSourced is true
- Setting setAIEnabled(true) dispatches SAVE_AI_SETTINGS to worker
  </verify>
  <done>
AI settings persist to Dexie and load on app startup via worker READY payload. AI-sourced atoms are tagged in the inbox classify handler. AtomCard shows a subtle AI badge on AI-sourced atoms. The aiFirstRunComplete flag persists correctly (fixes Phase 4 deferred bug).
  </done>
</task>

</tasks>

<verification>
1. Open app, go to AI Settings (Ctrl+P -> "AI Settings"), toggle AI enabled on
2. Reload the page — AI enabled toggle should still be on (persisted)
3. Verify aiFirstRunComplete persists — guided setup wizard should NOT reappear after initial completion and reload
4. Check that no existing atoms have AI badge (all have aiSourced: false from v3 migration)
5. `pnpm build` succeeds without errors
</verification>

<success_criteria>
- Atom type has optional aiSourced field indexed in Dexie
- Changelog type has optional source and aiRequestId fields
- AI settings persist across reloads via Dexie config table
- AI badge renders on AtomCard for AI-sourced atoms
- CLASSIFY_INBOX_ITEM supports aiSourced flag
- Zero regressions in existing atom CRUD operations
</success_criteria>

<output>
After completion, create `.planning/phases/05-triage-ai/05-02-SUMMARY.md`
</output>
