---
phase: 05-triage-ai
plan: 04
type: execute
wave: 3
depends_on: ["05-01", "05-03"]
files_modified:
  - src/ui/components/InboxAISuggestion.tsx
  - src/ui/components/AIQuestionFlow.tsx
  - src/ui/views/InboxView.tsx
  - src/ui/components/AIOrb.tsx
  - src/ui/layout/layout.css
autonomous: false
requirements: [AIUX-03, AIUX-04]

must_haves:
  truths:
    - "Each inbox card shows an AI suggestion strip with suggested type, section, one-liner reasoning (expandable for more detail via Show more/less toggle), and related atom chips when a suggestion exists"
    - "Swiping right on a card with an active suggestion accepts the suggestion (applies type/section via CLASSIFY_INBOX_ITEM)"
    - "Swiping left on a card with an active suggestion dismisses the suggestion only (card stays in inbox)"
    - "An 'Accept all' button appears after the user has reviewed a few suggestions"
    - "High-confidence suggestions display a solid suggestion line; low-confidence use a dotted/lighter treatment"
    - "Tapping the Triage action on the radial menu triggers batch triage of all inbox items"
    - "AIQuestionFlow component renders 3-4 option buttons plus a freeform text input, reusable for Phases 6-7, closable via Escape key or backdrop click"
  artifacts:
    - path: "src/ui/components/InboxAISuggestion.tsx"
      provides: "Per-card AI suggestion strip with type/section/reasoning/confidence/related atoms"
      min_lines: 40
    - path: "src/ui/components/AIQuestionFlow.tsx"
      provides: "Reusable conversational question-flow component (3-4 options + freeform input)"
      min_lines: 40
    - path: "src/ui/views/InboxView.tsx"
      provides: "InboxView augmented with AI suggestion strip and modified swipe semantics"
      contains: "InboxAISuggestion"
  key_links:
    - from: "src/ui/views/InboxView.tsx"
      to: "src/ui/signals/store.ts"
      via: "reads triageSuggestions() signal to conditionally render suggestion strip"
      pattern: "triageSuggestions"
    - from: "src/ui/views/InboxView.tsx"
      to: "src/ui/signals/store.ts"
      via: "calls acceptAISuggestion/dismissAISuggestion on swipe"
      pattern: "acceptAISuggestion|dismissAISuggestion"
    - from: "src/ui/components/AIOrb.tsx"
      to: "src/ui/signals/store.ts"
      via: "onAction('triage') calls startTriageInbox()"
      pattern: "startTriageInbox"
---

<objective>
Wire the triage UI into InboxView — render inline AI suggestions on inbox cards, modify swipe gestures for accept/dismiss, connect the orb's Triage action, and create the reusable question-flow component.

Purpose: This plan connects the triage pipeline (Plan 03) to the user-facing UI (Plan 01 orb + InboxView). Users tap the orb, AI processes inbox items, suggestions appear on each card, and users swipe to accept or dismiss. The AIQuestionFlow component (AIUX-03) provides the reusable shell for all AI interactions.

Output: InboxAISuggestion.tsx, AIQuestionFlow.tsx, modified InboxView.tsx with suggestion-aware swipe logic, orb triage action wiring.
</objective>

<execution_context>
@C:/Users/patri/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/patri/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-triage-ai/05-CONTEXT.md
@.planning/phases/05-triage-ai/05-RESEARCH.md
@.planning/phases/05-triage-ai/05-01-SUMMARY.md
@.planning/phases/05-triage-ai/05-03-SUMMARY.md
@src/ui/views/InboxView.tsx
@src/ui/components/AIOrb.tsx
@src/ui/signals/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InboxAISuggestion component, modify InboxView swipe semantics, and wire orb Triage action</name>
  <files>src/ui/components/InboxAISuggestion.tsx, src/ui/views/InboxView.tsx, src/ui/components/AIOrb.tsx, src/ui/layout/layout.css</files>
  <action>
**1. Create src/ui/components/InboxAISuggestion.tsx:**

A SolidJS component that renders the AI suggestion strip inline on an inbox triage card.

Props:
```typescript
interface InboxAISuggestionProps {
  suggestion: TriageSuggestion;
  onAccept: () => void;
  onDismiss: () => void;
  onAtomClick: (atomId: string) => void; // navigates to related atom
  atoms: Atom[]; // for resolving related atom names
  sectionItems: SectionItem[]; // for resolving section name
}
```

**Expandable reasoning** — Per CONTEXT.md locked decision: "Expandable for more detail." Create a `const [expanded, setExpanded] = createSignal(false)` inside the component. The reasoning line shows a truncated one-liner by default (CSS `overflow: hidden; text-overflow: ellipsis; white-space: nowrap` on `.ai-suggestion-reasoning`). A "Show more" / "Show less" button (`<button class="ai-suggestion-expand">`) toggles the `expanded` signal. When expanded, the reasoning `<div>` gets class `ai-suggestion-reasoning--expanded` which removes the truncation (`white-space: normal; overflow: visible`) and optionally shows a secondary detail section (`.ai-suggestion-detail`) with related atom context or additional reasoning if provided by the AI.

Render structure:
```
<div class="ai-suggestion-strip {confidence class}">
  <div class="ai-suggestion-header">
    <AtomTypeIcon type={suggestion.suggestedType} size={14} />
    <span class="ai-suggestion-type">{suggestion.suggestedType}</span>
    <Show when={sectionName}>
      <span class="ai-suggestion-section">in {sectionName}</span>
    </Show>
    <span class="ai-suggestion-badge" title="AI-suggested">AI</span>
  </div>
  <div class={`ai-suggestion-reasoning ${expanded() ? 'ai-suggestion-reasoning--expanded' : ''}`}>
    {suggestion.reasoning}
  </div>
  <button class="ai-suggestion-expand" onClick={() => setExpanded(!expanded())}>
    {expanded() ? 'Show less' : 'Show more'}
  </button>
  <Show when={relatedAtoms.length > 0}>
    <div class="ai-suggestion-related">
      <For each={relatedAtoms}>
        {(atom) => (
          <button class="ai-suggestion-chip" onClick={() => props.onAtomClick(atom.id)} title={atom.content.slice(0, 100)}>
            {atom.title || atom.content.slice(0, 30)}
          </button>
        )}
      </For>
    </div>
  </Show>
  <div class="ai-suggestion-actions">
    <button class="ai-suggestion-accept" onClick={props.onAccept}>Accept</button>
    <button class="ai-suggestion-dismiss" onClick={props.onDismiss}>Dismiss</button>
  </div>
</div>
```

**Confidence visual** (CONTEXT.md: "Subtle confidence signal"):
- High confidence: class `ai-suggestion-strip--high` — solid left border (`border-left: 3px solid var(--accent)`)
- Low confidence: class `ai-suggestion-strip--low` — dotted left border (`border-left: 3px dotted var(--text-tertiary)`)
- No numbers or labels for confidence (CONTEXT.md locked decision)

**Related atoms** (AITG-04): Resolve `suggestion.relatedAtomIds` to actual atom objects from `props.atoms`. Render as compact clickable chips. Clicking a chip navigates to that atom via `setSelectedAtomId`. Show atom title (or first 30 chars of content if no title).

**Pending/analyzing state**: If `suggestion.status === 'pending'`, render a compact "Analyzing..." indicator strip with a subtle pulsing animation (reuse `orbIdlePulse` timing) instead of the full suggestion. Style: `.ai-suggestion-strip--pending` with `opacity: 0.7` and `animation: aiAnalyzingPulse 1.5s ease-in-out infinite`. Add `@keyframes aiAnalyzingPulse` (opacity 0.5 to 0.9) in layout.css.

**Error state**: If `suggestion.status === 'error'`, render a simple "Suggestion failed — tap Triage to retry" message instead of the suggestion strip.

**CSS in layout.css** — Add in `/* Phase 5: AI Suggestions */` section:
- `.ai-suggestion-strip` — padding, margin-top, border-radius, background: `var(--bg-secondary)`
- `.ai-suggestion-strip--high` and `--low` confidence variants
- `.ai-suggestion-header` — flex row with type icon, type name, section, AI badge
- `.ai-suggestion-reasoning` — font-size smaller, color: `var(--text-secondary)`, `overflow: hidden; text-overflow: ellipsis; white-space: nowrap` (truncated by default)
- `.ai-suggestion-reasoning--expanded` — `white-space: normal; overflow: visible` (expanded state)
- `.ai-suggestion-expand` — inline text button, font-size 11px, color: `var(--accent)`, cursor: pointer, no border/background
- `.ai-suggestion-detail` — margin-top: 4px, font-size smaller, color: `var(--text-tertiary)` (secondary detail when expanded)
- `.ai-suggestion-related` — flex row of chips
- `.ai-suggestion-chip` — small rounded buttons, truncated text, `max-width: 120px`
- `.ai-suggestion-actions` — flex row of accept/dismiss buttons (fallback for non-touch users)
- `.ai-suggestion-accept` / `.ai-suggestion-dismiss` button styles
- `.ai-suggestion-strip--pending` — `opacity: 0.7; animation: aiAnalyzingPulse 1.5s ease-in-out infinite`
- `@keyframes aiAnalyzingPulse` — `0% { opacity: 0.5 } 50% { opacity: 0.9 } 100% { opacity: 0.5 }`

**2. Modify InboxView.tsx to render suggestions and change swipe semantics:**

Import new dependencies at top of InboxView.tsx:
```typescript
import { InboxAISuggestion } from '../components/InboxAISuggestion';
import { triageSuggestions, acceptAISuggestion, dismissAISuggestion, acceptAllAISuggestions, triageStatus, setSelectedAtomId } from '../signals/store';
```

**Render suggestion strip** — Inside the triage card JSX (after the swipe hints, before the closing `</div>` of `.inbox-triage-card`), add:
```tsx
<Show when={triageSuggestions().get(currentItem()!.id)}>
  {(suggestion) => (
    <InboxAISuggestion
      suggestion={suggestion()}
      onAccept={() => acceptAISuggestion(currentItem()!.id)}
      onDismiss={() => dismissAISuggestion(currentItem()!.id)}
      onAtomClick={(atomId) => setSelectedAtomId(atomId)}
      atoms={state.atoms}
      sectionItems={state.sectionItems}
    />
  )}
</Show>
```

**Modify swipe semantics** (CRITICAL — per RESEARCH.md Pitfall 2):
In `handleTouchEnd`, at the TOP of the function (before any existing swipe direction checks), add a suggestion-aware branch:

```typescript
const hasSuggestion = currentItem() ? triageSuggestions().has(currentItem()!.id) : false;

// Swipe RIGHT with suggestion -> accept AI suggestion
if (hasSuggestion && (dx > 80 || (dx > 30 && velocityX > 0.5))) {
  setCardTranslateX(300); // animate right
  setTimeout(() => {
    setCardTranslateX(0);
    acceptAISuggestion(currentItem()!.id);
    // Index adjusts automatically since item is removed from inboxItems
    if (currentIndex() >= state.inboxItems.length) {
      setCurrentIndex(Math.max(0, state.inboxItems.length - 1));
    }
    if (state.inboxItems.length === 0) setEmptyAnimation(true);
  }, 300);
  return;
}

// Swipe LEFT with suggestion -> dismiss suggestion (card stays)
if (hasSuggestion && (dx < -80 || (dx < -30 && velocityX > 0.5))) {
  dismissAISuggestion(currentItem()!.id);
  setCardTranslateX(0);
  setCardTranslateY(0);
  return;
}
```

Place this BEFORE the existing swipe-right (classify) and swipe-left (skip) handlers. When no suggestion is present, existing behavior is preserved exactly.

**"Accept all" button** — Add below the inbox counter, visible when triageStatus() is 'complete' and suggestions Map has 2+ entries:
```tsx
<Show when={triageStatus() === 'complete' && triageSuggestions().size >= 2}>
  <button class="inbox-accept-all" onClick={acceptAllAISuggestions}>
    Accept all ({triageSuggestions().size} suggestions)
  </button>
</Show>
```

**3. Wire the orb Triage action in AIOrb.tsx:**

In the AIOrb component (or AIRadialMenu), update the `onAction` handler for 'triage':
```typescript
import { startTriageInbox } from '../signals/store';

// In the onAction handler:
case 'triage':
  startTriageInbox();
  setMenuOpen(false);
  break;
```

Also wire 'discuss' to open the AIQuestionFlow (will be created in Task 2):
```typescript
import { setShowQuestionFlow } from '../components/AIQuestionFlow'; // module-level signal

case 'discuss':
  setShowQuestionFlow(true);
  setMenuOpen(false);
  break;
```

**Update swipe hints when suggestion is active** — When a suggestion exists on the current card, change the swipe hint labels:
- Left hint: "Dismiss" instead of "Skip"
- Right hint: "Accept" instead of "Classify"
- Up hint remains "Archive"
  </action>
  <verify>
- `npx tsc --noEmit` compiles
- `pnpm lint` passes
- InboxView renders InboxAISuggestion when suggestion exists for current item
- Swipe right with suggestion calls acceptAISuggestion
- Swipe left with suggestion calls dismissAISuggestion
- Swipe right WITHOUT suggestion still opens classify panel (existing behavior)
- "Accept all" button visible when triage is complete with 2+ suggestions
- Orb triage action calls startTriageInbox()
  </verify>
  <done>
InboxView augmented with inline AI suggestion strips on each card. Swipe semantics modified to accept/dismiss suggestions when present, preserving existing classify/skip behavior when no suggestion exists. Orb triage action wired to batch triage pipeline. Accept-all button available for bulk processing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AIQuestionFlow component (reusable for Phases 6-7)</name>
  <files>src/ui/components/AIQuestionFlow.tsx, src/ui/layout/Shell.tsx, src/ui/layout/layout.css</files>
  <action>
**Create src/ui/components/AIQuestionFlow.tsx:**

A reusable conversational question-flow component used by the "Discuss" orb action and future phases (6-7). This implements AIUX-03: 3-4 options + freeform input for all AI interactions.

**Module-level signal** (same pattern as Shell.tsx's setShowAISettings):
```typescript
const [showQuestionFlow, setShowQuestionFlow] = createSignal(false);
const [questionFlowContext, setQuestionFlowContext] = createSignal<QuestionFlowContext | null>(null);
export { showQuestionFlow, setShowQuestionFlow, setQuestionFlowContext };
```

**QuestionFlowContext type:**
```typescript
export interface QuestionFlowOption {
  id: string;
  label: string;
  description?: string;
}

export interface QuestionFlowContext {
  title: string;               // e.g., "What would you like to do with this atom?"
  description?: string;        // context about the current atom/page
  options: QuestionFlowOption[]; // 3-4 structured options
  allowFreeform: boolean;      // whether to show freeform input
  onSelect: (optionId: string) => void;     // called when user picks an option
  onFreeform: (text: string) => void;       // called when user submits freeform
  onClose: () => void;
}
```

**Component structure:**
```tsx
export function AIQuestionFlow() {
  const [freeformText, setFreeformText] = createSignal('');
  const ctx = () => questionFlowContext();

  // Escape key closes the panel
  createEffect(() => {
    if (!showQuestionFlow()) return;
    const handler = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        ctx()?.onClose();
        setShowQuestionFlow(false);
      }
    };
    document.addEventListener('keydown', handler);
    onCleanup(() => document.removeEventListener('keydown', handler));
  });

  return (
    <Show when={showQuestionFlow() && ctx()}>
      <div class="ai-question-flow-backdrop" onClick={() => { ctx()!.onClose(); setShowQuestionFlow(false); }}>
        <div class="ai-question-flow" onClick={(e) => e.stopPropagation()}>
          <div class="ai-qf-title">{ctx()!.title}</div>
          <Show when={ctx()!.description}>
            <div class="ai-qf-description">{ctx()!.description}</div>
          </Show>

          <div class="ai-qf-options">
            <For each={ctx()!.options}>
              {(option) => (
                <button
                  class="ai-qf-option"
                  onClick={() => { ctx()!.onSelect(option.id); setShowQuestionFlow(false); }}
                >
                  <span class="ai-qf-option-label">{option.label}</span>
                  <Show when={option.description}>
                    <span class="ai-qf-option-desc">{option.description}</span>
                  </Show>
                </button>
              )}
            </For>
          </div>

          <Show when={ctx()!.allowFreeform}>
            <div class="ai-qf-freeform">
              <input
                class="ai-qf-input"
                type="text"
                placeholder="Or type your own..."
                value={freeformText()}
                onInput={(e) => setFreeformText(e.currentTarget.value)}
                onKeyDown={(e) => {
                  if (e.key === 'Enter' && freeformText().trim()) {
                    ctx()!.onFreeform(freeformText().trim());
                    setFreeformText('');
                    setShowQuestionFlow(false);
                  }
                }}
              />
            </div>
          </Show>

          <button class="ai-qf-close" onClick={() => { ctx()!.onClose(); setShowQuestionFlow(false); }}>
            Cancel
          </button>
        </div>
      </div>
    </Show>
  );
}
```

**Shell.tsx integration:**
Import and render `<AIQuestionFlow />` in Shell.tsx after the AIOrb, in the Phase 5 overlays section.

**CSS in layout.css** — Add in `/* Phase 5: AI Question Flow */` section:
- `.ai-question-flow-backdrop` — fixed full-screen, semi-transparent dark background, z-index: 200
- `.ai-question-flow` — centered card, max-width: 400px, padding, background: var(--bg-primary), border-radius, box-shadow
- `.ai-qf-title` — font-size larger, font-weight 600, margin-bottom
- `.ai-qf-description` — color: var(--text-secondary), font-size smaller
- `.ai-qf-options` — flex column, gap: 8px
- `.ai-qf-option` — full-width button, text-align left, padding, border: 1px solid var(--border-primary), border-radius, hover: background var(--bg-secondary)
- `.ai-qf-option-label` — font-weight 500
- `.ai-qf-option-desc` — font-size smaller, color: var(--text-tertiary)
- `.ai-qf-freeform` — margin-top, padding-top, border-top
- `.ai-qf-input` — full-width text input matching existing input styles
- `.ai-qf-close` — text button, color: var(--text-secondary)

The "Discuss" radial action in AIOrb.tsx should set up a default question flow context appropriate to the current page:
- On inbox page: options like "Process all inbox items", "Tell me about this item", "Suggest organization"
- On other pages: options like "Summarize this section", "Find stale items", "Suggest connections"
- These are placeholder prompts in Phase 5 — the actual AI handling is wired in Phases 6-7

For Phase 5, the onSelect/onFreeform callbacks can be stubs that console.log the selection (actual AI conversation wiring deferred to later phases). The component structure and UI must be complete and reusable.
  </action>
  <verify>
- `npx tsc --noEmit` compiles
- `pnpm lint` passes
- AIQuestionFlow.tsx exports the component, showQuestionFlow, setShowQuestionFlow, setQuestionFlowContext, QuestionFlowContext type
- Shell.tsx renders `<AIQuestionFlow />`
- Clicking "Discuss" on the orb radial menu opens the question flow panel
- Selecting an option or typing freeform closes the panel
- Pressing Escape or clicking backdrop closes the panel
  </verify>
  <done>
AIQuestionFlow component renders a modal with 3-4 structured options and a freeform input. It's reusable for all AI interactions in Phases 5-7. The Discuss action on the orb opens it with context-appropriate options. Shell.tsx renders it as an overlay.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete triage flow end-to-end</name>
  <files>none (verification only)</files>
  <action>
Human verifies the complete AI triage system end-to-end. No code changes — this is a verification checkpoint.

What was built: Complete AI triage system — floating orb with radial menu, batch triage pipeline, inline suggestions on inbox cards with accept/dismiss, AI source tagging, settings persistence, and question-flow component.

Prerequisites: Have at least 3-5 items in the inbox. Have AI enabled in settings (either browser LLM or cloud API with API key configured).

Verification steps:
1. Orb visibility: Navigate between pages (Inbox, Today, All Items) — verify the orb is visible on every page at bottom-right
2. Orb interaction: Tap the orb — verify radial menu opens with 5 segments. On Inbox page, "Triage" should be the primary (highlighted) segment
3. Trigger triage: Tap "Triage" on the radial menu — orb should change to thinking (spinning) state
4. Suggestions appear: As triage completes, suggestions should appear on each inbox card with suggested atom type with icon, suggested section/project (if applicable), one-liner reasoning, 2-3 related atom chips (if matches found), and confidence visual (solid vs dotted left border)
5. Accept suggestion: Swipe right on a card with a suggestion — card should animate out, atom should be classified with the suggested type, and show an AI badge in its new location
6. Dismiss suggestion: Swipe left on a card with a suggestion — suggestion should disappear, card stays in inbox
7. Accept all: If 2+ suggestions remain, verify "Accept all" button appears and works
8. Settings persist: Toggle AI settings, reload page — settings should persist
9. Question flow: Tap orb, select "Discuss" — question flow panel should open with options and freeform input
10. Cancel triage: Start a triage, tap orb again mid-processing — verify cancellation preserves completed suggestions
  </action>
  <verify>User confirms all 10 verification steps pass, or describes issues to fix</verify>
  <done>Complete Phase 5 triage AI system verified working end-to-end by user. Resume signal: type "approved" or describe issues.</done>
</task>

</tasks>

<verification>
1. Full triage flow: Orb -> Triage -> suggestions appear -> accept/dismiss -> atoms classified with AI badge
2. Swipe semantics preserve existing behavior when no suggestions present
3. Settings persist across reload (aiEnabled, aiFirstRunComplete, etc.)
4. Question flow component renders correctly with options and freeform
5. Cancel mid-triage preserves completed suggestions
6. Zero TypeScript or lint errors
7. `pnpm build` succeeds
</verification>

<success_criteria>
- Inbox cards display inline AI suggestions with type, section, reasoning, and related atoms
- Swipe right accepts, swipe left dismisses (with fallback buttons for accessibility)
- Orb Triage action triggers batch processing of all inbox items
- Accept-all button works for bulk processing
- AIQuestionFlow component is reusable with 3-4 options + freeform
- All user decisions from CONTEXT.md implemented as specified
- End-to-end flow verified by user
</success_criteria>

<output>
After completion, create `.planning/phases/05-triage-ai/05-04-SUMMARY.md`
</output>
